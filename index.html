<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Happy Birthday Lakshtu üíñ</title>
<link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéÇ</text></svg>">
<style>
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Dancing+Script:wght@400;700&display=swap');

:root {
  /* Night Mode Variables */
  --bg-primary: #0b001a;
  --bg-secondary: #16002e;
  --text-primary: #ffffff;
  --text-secondary: rgba(255, 255, 255, 0.8);
  --accent: #ff4f9a;
  --accent-light: #ff8bd5;
  --peach: #ffb88c;
  --tree-trunk: #ff33cc;
  --tree-branch: #ff66ff;
  --glow-color: #ff4fa6;
  --card-bg: rgba(255, 255, 255, 0.05);
  --transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  
  /* Mobile Safe Areas */
  --safe-top: env(safe-area-inset-top, 0px);
  --safe-bottom: env(safe-area-inset-bottom, 0px);
  --safe-left: env(safe-area-inset-left, 0px);
  --safe-right: env(safe-area-inset-right, 0px);
}

/* Day Mode Variables */
.day-mode {
  --bg-primary: #f8f9ff;
  --bg-secondary: #ffffff;
  --text-primary: #2d2d2d;
  --text-secondary: rgba(45, 45, 45, 0.8);
  --accent: #ff4f9a;
  --accent-light: #ff8bd5;
  --peach: #ff9a6c;
  --tree-trunk: #8b4513;
  --tree-branch: #a0522d;
  --glow-color: #ff69b4;
  --card-bg: rgba(255, 255, 255, 0.9);
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  -webkit-tap-highlight-color: transparent;
  -webkit-touch-callout: none;
}

html {
  height: 100%;
  overflow: hidden;
}

body {
  margin: 0;
  font-family: 'Poppins', sans-serif;
  background: var(--bg-primary);
  color: var(--text-primary);
  overflow: hidden;
  transition: var(--transition);
  min-height: 100vh;
  min-height: -webkit-fill-available;
  background-image: 
    radial-gradient(circle at 20% 80%, rgba(255, 79, 166, 0.15) 0%, transparent 50%),
    radial-gradient(circle at 80% 20%, rgba(255, 184, 140, 0.1) 0%, transparent 50%);
  padding-top: var(--safe-top);
  padding-bottom: var(--safe-bottom);
  padding-left: var(--safe-left);
  padding-right: var(--safe-right);
}

/* Prevent text selection */
.no-select {
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

/* Mobile optimized touch targets */
.touch-target {
  min-height: 44px;
  min-width: 44px;
}

/* ==================== ENVELOPE SURPRISE PAGE ==================== */
#surprisePage {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100vh;
  height: 100dvh;
  background: linear-gradient(135deg, var(--bg-primary) 0%, #1a0033 100%);
  display: flex;
  justify-content: center;
  align-items: center;
  flex-direction: column;
  z-index: 10000;
  overflow: hidden;
  padding: 20px;
  padding-top: calc(20px + var(--safe-top));
  padding-bottom: calc(20px + var(--safe-bottom));
}

.envelope-container {
  position: relative;
  width: min(280px, 80vw);
  height: min(380px, 80vh);
  cursor: pointer;
  perspective: 1000px;
  touch-action: manipulation;
}

.envelope {
  position: absolute;
  width: 100%;
  height: 100%;
  transform-style: preserve-3d;
  animation: floatEnvelope 3s ease-in-out infinite;
}

.envelope-front, .envelope-back {
  position: absolute;
  width: 100%;
  height: 100%;
  backface-visibility: hidden;
  border-radius: 10px;
  overflow: hidden;
}

.envelope-front {
  background: linear-gradient(45deg, var(--accent), var(--accent-light));
  transform: rotateY(0deg);
  box-shadow: 
    0 10px 25px rgba(255, 79, 166, 0.3),
    0 0 40px rgba(255, 79, 166, 0.1);
  border: 2px solid rgba(255, 255, 255, 0.2);
}

.envelope-seal {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: min(70px, 25vw);
  height: min(70px, 25vw);
  background: linear-gradient(45deg, #ffcc00, #ff9900);
  border-radius: 50%;
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: min(35px, 8vw);
  box-shadow: 
    0 0 25px rgba(255, 204, 0, 0.5),
    inset 0 0 15px rgba(255, 255, 255, 0.3);
  border: 3px solid rgba(255, 255, 255, 0.4);
  animation: pulseSeal 2s ease-in-out infinite;
}

.envelope-seal::after {
  content: '';
  position: absolute;
  width: 80%;
  height: 80%;
  border: 2px dashed rgba(255, 255, 255, 0.6);
  border-radius: 50%;
}

.envelope-lid {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 50%;
  background: linear-gradient(45deg, var(--accent-light), #ff66cc);
  clip-path: polygon(0 0, 50% 100%, 100% 0);
  transform-origin: top;
  transition: transform 1s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  z-index: 2;
  box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.2);
}

.envelope.open .envelope-lid {
  transform: rotateX(-180deg);
}

.envelope-body {
  position: absolute;
  bottom: 0;
  left: 10%;
  width: 80%;
  height: 70%;
  background: linear-gradient(45deg, #ff3366, #ff6699);
  clip-path: polygon(0 0, 100% 0, 90% 100%, 10% 100%);
  z-index: 1;
}

.letter {
  position: absolute;
  top: 15px;
  left: 15px;
  right: 15px;
  bottom: 15px;
  background: white;
  border-radius: 5px;
  padding: min(20px, 5vw);
  transform: translateY(100%);
  transition: transform 1s cubic-bezier(0.68, -0.55, 0.265, 1.55) 0.5s;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
  z-index: 3;
  overflow: hidden;
}

.envelope.open .letter {
  transform: translateY(-10px);
}

.letter-content {
  font-family: 'Dancing Script', cursive;
  font-size: min(16px, 4vw);
  color: #333;
  text-align: center;
  line-height: 1.5;
}

.letter-content h2 {
  color: var(--accent);
  margin-bottom: 10px;
  font-size: min(22px, 6vw);
}

.sparkle {
  position: absolute;
  width: 8px;
  height: 8px;
  background: #fff;
  border-radius: 50%;
  animation: sparkle 1.5s infinite;
  pointer-events: none;
}

.instruction {
  position: absolute;
  bottom: max(30px, calc(5vh + var(--safe-bottom)));
  left: 0;
  width: 100%;
  text-align: center;
  font-size: min(1.1rem, 4.5vw);
  color: var(--text-secondary);
  opacity: 0;
  animation: fadeInInstruction 2s ease 1s forwards;
  padding: 0 20px;
}

.tap-text {
  display: inline-block;
  background: linear-gradient(45deg, var(--accent), var(--accent-light));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  font-weight: 700;
  margin: 0 5px;
  animation: tapPulse 2s infinite;
}

.countdown {
  position: absolute;
  top: max(20px, calc(2vh + var(--safe-top)));
  right: 20px;
  font-size: min(1.4rem, 6vw);
  font-weight: 700;
  color: var(--accent);
  opacity: 0;
  animation: countdownFade 0.5s ease 0.5s forwards;
}

/* Mobile touch feedback */
.envelope-container:active {
  transform: scale(0.98);
  transition: transform 0.1s ease;
}

@keyframes floatEnvelope {
  0%, 100% { transform: translateY(0) rotate(0deg); }
  50% { transform: translateY(-15px) rotate(2deg); }
}

@keyframes pulseSeal {
  0%, 100% { 
    transform: translate(-50%, -50%) scale(1);
    box-shadow: 
      0 0 25px rgba(255, 204, 0, 0.5),
      inset 0 0 15px rgba(255, 255, 255, 0.3);
  }
  50% { 
    transform: translate(-50%, -50%) scale(1.05);
    box-shadow: 
      0 0 35px rgba(255, 204, 0, 0.8),
      inset 0 0 25px rgba(255, 255, 255, 0.5);
  }
}

@keyframes sparkle {
  0% {
    transform: scale(0) rotate(0deg);
    opacity: 1;
  }
  100% {
    transform: scale(1) rotate(180deg);
    opacity: 0;
  }
}

@keyframes fadeInInstruction {
  to { opacity: 1; }
}

@keyframes tapPulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.05); }
}

@keyframes countdownFade {
  to { opacity: 1; }
}

@keyframes surpriseReveal {
  0% {
    opacity: 1;
    transform: scale(1);
  }
  100% {
    opacity: 0;
    transform: scale(1.2);
    display: none;
  }
}

/* ==================== MOBILE OPTIMIZED CONTROLS ==================== */

/* Mood Toggle Button - Mobile Optimized */
#moodToggle {
  position: fixed;
  top: max(15px, calc(1vh + var(--safe-top)));
  right: 15px;
  padding: 10px 16px;
  border: none;
  border-radius: 25px;
  background: var(--card-bg);
  backdrop-filter: blur(10px);
  color: var(--text-primary);
  cursor: pointer;
  font-weight: 600;
  font-size: min(0.85rem, 3.5vw);
  z-index: 1000;
  transition: var(--transition);
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
  display: flex;
  align-items: center;
  gap: 6px;
  min-height: 44px;
  touch-action: manipulation;
}

#moodToggle:active {
  transform: scale(0.95);
}

/* Music Player - Mobile Optimized */
#musicPlayer {
  position: fixed;
  bottom: max(20px, calc(2vh + var(--safe-bottom)));
  left: 15px;
  z-index: 1000;
}

#musicToggle {
  width: min(50px, 12vw);
  height: min(50px, 12vw);
  border-radius: 50%;
  background: var(--card-bg);
  backdrop-filter: blur(10px);
  border: 2px solid var(--accent);
  color: var(--accent);
  cursor: pointer;
  font-size: min(1.1rem, 5vw);
  transition: var(--transition);
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
  touch-action: manipulation;
}

#musicToggle:active {
  transform: scale(0.9);
}

/* Skip Button - Mobile Optimized */
.skip-btn {
  position: fixed;
  bottom: max(80px, calc(10vh + var(--safe-bottom)));
  right: 15px;
  padding: min(12px, 3vw) min(20px, 5vw);
  background: var(--accent);
  color: white;
  border: none;
  border-radius: 25px;
  cursor: pointer;
  font-weight: 600;
  font-size: min(0.85rem, 3.5vw);
  z-index: 1000;
  opacity: 0;
  transform: translateY(20px);
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(255, 79, 166, 0.3);
  min-height: 44px;
  touch-action: manipulation;
}

.skip-btn.show {
  opacity: 1;
  transform: translateY(0);
}

.skip-btn:active {
  transform: scale(0.95) translateY(0);
}

/* Back Button - Mobile Optimized */
.back-btn {
  position: fixed;
  top: max(15px, calc(1vh + var(--safe-top)));
  left: 15px;
  padding: min(10px, 2.5vw) min(15px, 4vw);
  background: var(--card-bg);
  color: var(--text-primary);
  border: none;
  border-radius: 20px;
  cursor: pointer;
  font-weight: 600;
  font-size: min(0.8rem, 3.2vw);
  z-index: 1000;
  opacity: 0;
  transition: all 0.3s ease;
  backdrop-filter: blur(10px);
  min-height: 44px;
  touch-action: manipulation;
}

.back-btn.show {
  opacity: 1;
}

.back-btn:active {
  transform: scale(0.95);
}

/* Memory Counter - Mobile Optimized */
.memory-counter {
  position: fixed;
  top: max(15px, calc(1vh + var(--safe-top)));
  left: 50%;
  transform: translateX(-50%);
  background: var(--card-bg);
  padding: min(8px, 2vw) min(16px, 4vw);
  border-radius: 20px;
  font-size: min(0.85rem, 3.5vw);
  font-weight: 600;
  backdrop-filter: blur(10px);
  z-index: 1000;
  opacity: 0;
  transition: opacity 0.3s ease;
  white-space: nowrap;
}

.memory-counter.show {
  opacity: 1;
}

/* Progress Indicator - Mobile Optimized */
.progress-indicator {
  position: fixed;
  top: max(15px, calc(1vh + var(--safe-top)));
  left: 15px;
  display: flex;
  gap: 8px;
  z-index: 1000;
}

.dot {
  width: min(10px, 2.5vw);
  height: min(10px, 2.5vw);
  border-radius: 50%;
  background: var(--text-secondary);
  transition: var(--transition);
}

.dot.active {
  background: var(--accent);
  transform: scale(1.2);
  box-shadow: 0 0 8px var(--glow-color);
}

/* ==================== MAIN STAGES ==================== */
.stage {
  display: none;
  width: 100%;
  height: 100vh;
  height: 100dvh;
  position: absolute;
  top: 0;
  left: 0;
  justify-content: center;
  align-items: center;
  flex-direction: column;
  opacity: 0;
  transition: opacity 0.8s ease, transform 0.8s ease;
  padding: 20px;
  padding-top: calc(20px + var(--safe-top));
  padding-bottom: calc(20px + var(--safe-bottom));
  transform: translateY(20px);
  overflow: hidden;
}

.stage.active {
  display: flex;
  opacity: 1;
  transform: translateY(0);
}

/* Tree Stage - Mobile Optimized */
#treeStage {
  background: var(--bg-primary);
  overflow: hidden;
}

#treeContainer {
  width: min(90vw, 500px);
  height: min(70vh, 500px);
  position: relative;
  margin-bottom: min(30px, 5vh);
}

#treeCanvas {
  width: 100%;
  height: 100%;
  position: absolute;
  top: 0;
  left: 0;
  touch-action: none;
}

.leaf {
  position: absolute;
  width: min(20px, 5vw);
  height: min(20px, 5vw);
  background: var(--accent);
  transform: translate(-50%, -50%) scale(0) rotate(0deg);
  clip-path: polygon(50% 0%, 61% 7%, 72% 17%, 80% 28%, 85% 40%, 87% 52%, 86% 63%, 82% 72%, 75% 81%, 66% 88%, 56% 93%, 50% 95%, 44% 93%, 34% 88%, 25% 81%, 18% 72%, 14% 63%, 13% 52%, 15% 40%, 20% 28%, 28% 17%, 39% 7%);
  transition: transform 0.8s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.8s ease;
  filter: drop-shadow(0 0 6px var(--glow-color));
  opacity: 0;
}

.leaf.grow {
  transform: translate(-50%, -50%) scale(1) rotate(360deg);
  opacity: 1;
  animation: leafFloat 6s ease-in-out infinite;
}

@keyframes leafFloat {
  0%, 100% { transform: translate(-50%, -50%) scale(1) rotate(360deg) translateY(0); }
  50% { transform: translate(-50%, -50%) scale(1) rotate(360deg) translateY(-6px); }
}

/* Petals - Mobile Optimized */
.petals {
  position: absolute;
  width: min(10px, 3vw);
  height: min(10px, 3vw);
  background: var(--accent);
  border-radius: 50% 0 50% 50%;
  opacity: 0;
  animation: petalFall linear infinite;
  filter: drop-shadow(0 0 5px var(--glow-color));
  z-index: 1;
}

@keyframes petalFall {
  0% {
    transform: translateY(-100px) rotate(0deg) scale(0);
    opacity: 0;
  }
  10% {
    opacity: 1;
    transform: translateY(-60px) rotate(45deg) scale(1);
  }
  90% {
    opacity: 1;
  }
  100% {
    transform: translateY(100vh) rotate(720deg) scale(0);
    opacity: 0;
  }
}

/* Cake - Mobile Optimized */
#cake {
  width: min(220px, 60vw);
  margin-top: min(20px, 3vh);
  transform: scale(0);
  transition: transform 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
  filter: drop-shadow(0 0 20px rgba(255, 255, 255, 0.3));
  cursor: pointer;
  z-index: 10;
  border-radius: 15px;
  opacity: 0;
  touch-action: manipulation;
}

#cake.show {
  transform: scale(1);
  opacity: 1;
  animation: cakeGlow 3s ease-in-out infinite alternate;
}

#cake:active {
  transform: scale(0.95);
}

@keyframes cakeGlow {
  0% { filter: drop-shadow(0 0 15px rgba(255, 255, 255, 0.3)); }
  100% { filter: drop-shadow(0 0 30px rgba(255, 255, 255, 0.5)); }
}

/* Final Stage - Mobile Optimized */
#finalStage {
  flex-direction: column;
  background: linear-gradient(180deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
  overflow-y: auto;
  overflow-x: hidden;
  align-items: center;
  padding-top: max(60px, calc(8vh + var(--safe-top)));
  padding-bottom: max(40px, calc(6vh + var(--safe-bottom)));
  -webkit-overflow-scrolling: touch;
}

#finalStage h1 {
  font-size: min(2rem, 8vw);
  margin-bottom: min(20px, 3vh);
  text-align: center;
  color: var(--accent);
  font-family: 'Dancing Script', cursive;
  text-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
  animation: titleGlow 3s ease-in-out infinite alternate;
  padding: 0 15px;
}

@keyframes titleGlow {
  0% { text-shadow: 0 2px 8px rgba(0, 0, 0, 0.2); }
  100% { text-shadow: 0 2px 15px var(--glow-color); }
}

/* Gallery - Mobile Optimized */
.gallery {
  display: flex;
  flex-wrap: wrap;
  gap: min(15px, 3vw);
  justify-content: center;
  margin: min(20px, 3vh) 0;
  padding: 0 min(15px, 3vw);
  max-width: 100%;
}

.gallery img {
  width: 100%;
  max-width: min(300px, 85vw);
  height: min(300px, 70vh);
  object-fit: cover;
  border-radius: 15px;
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
  transition: var(--transition);
  cursor: pointer;
  animation: imageFloat 6s ease-in-out infinite;
  touch-action: manipulation;
}

.gallery img:active {
  transform: scale(0.98);
}

.gallery img.special {
  max-width: min(320px, 90vw);
  height: min(350px, 75vh);
  animation-delay: -1s;
}

.gallery img.pic2 {
  max-width: min(340px, 95vw);
  height: min(400px, 80vh);
  object-fit: contain;
  background-color: var(--bg-secondary);
  animation-delay: -2s;
}

@keyframes imageFloat {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-10px); }
}

/* Love Meter - Mobile Optimized */
.love-meter {
  width: min(200px, 70vw);
  height: min(18px, 5vw);
  background: var(--card-bg);
  border-radius: 10px;
  margin: min(15px, 2vh) auto;
  overflow: hidden;
  position: relative;
}

.love-fill {
  position: absolute;
  height: 100%;
  background: linear-gradient(90deg, var(--accent), var(--accent-light));
  border-radius: 10px;
  transition: width 1s ease;
  width: 0%;
}

.love-text {
  position: absolute;
  width: 100%;
  text-align: center;
  font-size: min(0.75rem, 3vw);
  font-weight: 600;
  line-height: min(18px, 5vw);
  color: white;
  z-index: 2;
}

/* Date Counter - Mobile Optimized */
.date-counter {
  background: var(--card-bg);
  padding: min(15px, 4vw) min(20px, 5vw);
  border-radius: 15px;
  text-align: center;
  margin: min(15px, 2vh) 0;
  backdrop-filter: blur(10px);
  width: min(250px, 80vw);
}

.date-counter h3 {
  color: var(--accent);
  margin-bottom: min(8px, 1vh);
  font-size: min(1.1rem, 4.5vw);
}

.date-number {
  font-size: min(2rem, 10vw);
  font-weight: 700;
  color: var(--accent);
  text-shadow: 0 0 8px var(--glow-color);
}

.date-label {
  font-size: min(0.8rem, 3.2vw);
  color: var(--text-secondary);
  margin-top: min(5px, 0.5vh);
}

/* Letter Box - Mobile Optimized */
#letterBox {
  width: 90%;
  max-width: min(700px, 95vw);
  margin: min(25px, 3vh) auto;
  padding: min(25px, 5vw);
  font-size: min(1rem, 4vw);
  line-height: 1.6;
  background: var(--card-bg);
  backdrop-filter: blur(10px);
  border-radius: 20px;
  color: var(--text-primary);
  box-shadow: 0 6px 25px rgba(0, 0, 0, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.1);
  font-family: 'Poppins', sans-serif;
  position: relative;
  overflow: hidden;
  min-height: min(200px, 40vh);
  opacity: 0;
  transform: translateY(20px);
  transition: opacity 0.8s ease, transform 0.8s ease;
}

#letterBox.show {
  opacity: 1;
  transform: translateY(0);
}

#letterBox::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, var(--accent), var(--accent-light));
}

/* Typewriter Styles */
.typing-text {
  display: inline;
}

.cursor {
  display: inline-block;
  width: 2px;
  height: min(20px, 5vw);
  background: var(--accent);
  animation: blink 1s infinite;
  margin-left: 2px;
  vertical-align: middle;
}

@keyframes blink {
  0%, 50% { opacity: 1; }
  51%, 100% { opacity: 0; }
}

/* Heart Rain - Mobile Optimized */
.heart {
  position: absolute;
  font-size: min(18px, 5vw);
  animation: heartFall linear infinite;
  opacity: 0;
  z-index: 0;
  pointer-events: none;
}

@keyframes heartFall {
  0% {
    transform: translateY(-50px) rotate(0deg) scale(0);
    opacity: 0;
  }
  10% {
    opacity: 1;
    transform: translateY(-30px) rotate(0deg) scale(1);
  }
  90% {
    opacity: 1;
  }
  100% {
    transform: translateY(100vh) rotate(360deg) scale(0);
    opacity: 0;
  }
}

/* Loading Screen */
#loading {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100vh;
  height: 100dvh;
  background: var(--bg-primary);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  transition: opacity 0.5s ease;
}

.loader {
  width: min(50px, 15vw);
  height: min(50px, 15vw);
  border: 3px solid var(--card-bg);
  border-top: 3px solid var(--accent);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Mobile Instruction Text */
.mobile-instruction {
  display: none;
  position: absolute;
  bottom: max(20px, calc(3vh + var(--safe-bottom)));
  width: 100%;
  text-align: center;
  font-size: min(0.9rem, 3.8vw);
  color: var(--text-secondary);
  opacity: 0.8;
  animation: pulse 2s infinite;
  padding: 0 15px;
}

@keyframes pulse {
  0%, 100% { opacity: 0.6; }
  50% { opacity: 1; }
}

/* ==================== MOBILE SPECIFIC STYLES ==================== */
@media (max-width: 768px) {
  .mobile-instruction {
    display: block;
  }
  
  .instruction {
    font-size: min(1rem, 4vw);
  }
  
  .envelope-container {
    width: min(250px, 75vw);
    height: min(340px, 75vh);
  }
  
  .letter-content {
    font-size: min(14px, 3.5vw);
  }
  
  .letter-content h2 {
    font-size: min(20px, 5.5vw);
  }
  
  .gallery {
    flex-direction: column;
    align-items: center;
  }
  
  .gallery img {
    max-width: 90%;
    height: auto;
    aspect-ratio: 3/4;
  }
  
  .gallery img.special {
    max-width: 95%;
  }
  
  .gallery img.pic2 {
    max-width: 100%;
  }
}

@media (max-width: 480px) {
  .envelope-container {
    width: min(220px, 70vw);
    height: min(300px, 70vh);
  }
  
  .envelope-seal {
    width: min(60px, 20vw);
    height: min(60px, 20vw);
    font-size: min(28px, 7vw);
  }
  
  #finalStage h1 {
    font-size: min(1.8rem, 7vw);
  }
  
  #letterBox {
    padding: min(20px, 4vw);
    font-size: min(0.9rem, 3.8vw);
  }
  
  .date-counter {
    padding: min(12px, 3vw) min(15px, 4vw);
  }
  
  .date-number {
    font-size: min(1.8rem, 8vw);
  }
}

/* Portrait Orientation */
@media (orientation: portrait) {
  .envelope-container {
    margin-top: 5vh;
  }
  
  #treeContainer {
    height: min(60vh, 400px);
  }
}

/* Landscape Orientation */
@media (orientation: landscape) and (max-height: 600px) {
  #surprisePage {
    flex-direction: row;
    gap: 20px;
  }
  
  .envelope-container {
    width: min(220px, 40vw);
    height: min(300px, 70vh);
  }
  
  .instruction {
    position: relative;
    bottom: auto;
    width: auto;
    max-width: 300px;
  }
  
  #treeContainer {
    height: min(70vh, 400px);
  }
  
  #finalStage h1 {
    font-size: min(1.6rem, 4vw);
  }
  
  .gallery {
    flex-direction: row;
    flex-wrap: nowrap;
    overflow-x: auto;
    justify-content: flex-start;
    padding-bottom: 10px;
  }
  
  .gallery img {
    flex: 0 0 auto;
    width: min(200px, 30vw);
    height: min(250px, 60vh);
  }
}

/* Very Small Screens */
@media (max-height: 500px) {
  .envelope-container {
    margin-top: 0;
  }
  
  .instruction {
    bottom: max(15px, calc(2vh + var(--safe-bottom)));
  }
  
  #treeContainer {
    height: min(50vh, 300px);
    margin-bottom: 15px;
  }
  
  #cake {
    width: min(180px, 50vw);
  }
}
</style>
</head>
<body class="night-mode no-select">

<!-- Loading Screen -->
<div id="loading">
  <div class="loader"></div>
</div>

<!-- Surprise Envelope Page -->
<div id="surprisePage">
  <div class="countdown" id="countdown">3</div>
  <div class="envelope-container touch-target" id="envelopeContainer">
    <div class="envelope" id="envelope">
      <div class="envelope-lid"></div>
      <div class="envelope-body"></div>
      <div class="envelope-seal">üíù</div>
      <div class="letter">
        <div class="letter-content">
          <h2>For Lakshtu üíñ</h2>
          <p>A special surprise awaits you...</p>
          <p>Are you ready to see what's inside?</p>
          <p style="margin-top: 15px; font-size: 20px;">üéÅ‚ú®üéÇ</p>
        </div>
      </div>
    </div>
  </div>
  <div class="instruction">
    <span class="tap-text">TAP</span> the envelope to open your surprise!
  </div>
  <div class="mobile-instruction">Tap anywhere to begin</div>
</div>

<!-- Progress Indicator -->
<div class="progress-indicator">
  <div class="dot active" data-stage="1"></div>
  <div class="dot" data-stage="2"></div>
  <div class="dot" data-stage="3"></div>
</div>

<!-- Back Button -->
<button class="back-btn touch-target" id="backBtn">‚Üê Back</button>

<!-- Memory Counter -->
<div class="memory-counter" id="memoryCounter">Memories: 0/3</div>

<!-- Mood Toggle -->
<button id="moodToggle" class="touch-target" title="Toggle Day/Night Mode">
  <span class="emoji">‚òÄÔ∏è</span>
  <span class="text">Day Mode</span>
</button>

<!-- Music Player -->
<div id="musicPlayer">
  <button id="musicToggle" class="touch-target" title="Toggle Music">üéµ</button>
</div>

<!-- Skip Button -->
<button class="skip-btn touch-target" id="skipBtn">Skip ‚è©</button>

<!-- Stage 1: Tree -->
<div id="treeStage" class="stage">
  <div id="treeContainer">
    <canvas id="treeCanvas"></canvas>
  </div>
  <img src="cake.jpg" id="cake" class="touch-target" alt="Birthday Cake" onerror="this.onerror=null; this.src='data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path fill=\"%23ff4f9a\" d=\"M12 6a2 2 0 002-2c0-.38-.1-.73-.29-1.03L12 0l-1.71 2.97c-.19.3-.29.65-.29 1.03 0 1.1.9 2 2 2zm4.6 9.99l-1.07-1.07-1.08 1.07c-1.3 1.3-3.58 1.31-4.89 0L8.47 14.92 7.4 16c-1.3 1.3-3.58 1.31-4.89 0-.39-.39-.39-1.02 0-1.41l1.07-1.07-1.07-1.07c-.39-.39-.39-1.02 0-1.41.39-.39 1.02-.39 1.41 0l1.07 1.07 1.07-1.07c.39-.39 1.02-.39 1.41 0 .39.39.39 1.02 0 1.41l-1.07 1.07 1.07 1.07c.39.39.39 1.02 0 1.41zM18 9h-5V7h-2v2H6c-1.66 0-3 1.34-3 3v1.54c0 1.08.88 1.96 1.96 1.96.52 0 1.02-.2 1.38-.57l2.14-2.13 2.13 2.13c.74.74 2.03.74 2.77 0l2.14-2.13 2.13 2.13c.37.37.86.57 1.38.57 1.08 0 1.96-.88 1.96-1.96V12C21 10.34 19.66 9 18 9z\"/></svg>'">
  <div class="mobile-instruction">Tap the cake to continue</div>
</div>

<!-- Stage 2: Memories & Letter -->
<div id="finalStage" class="stage">
  <h1>Our Beautiful Memories üíó</h1>
  
  <!-- Love Meter -->
  <div class="love-meter">
    <div class="love-fill" id="loveFill"></div>
    <div class="love-text" id="loveText">Love Level: 0%</div>
  </div>
  
  <!-- Date Counter -->
  <div class="date-counter">
    <h3>Days Together</h3>
    <div class="date-number" id="daysCounter">0</div>
    <div class="date-label">and counting...</div>
  </div>
  
  <div class="gallery">
    <img src="pic_one.jpg" class="special touch-target" alt="Special Memory" onerror="this.onerror=null; this.src='data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path fill=\"%23ff4f9a\" d=\"M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z\"/></svg>'">
    <img src="pic_two.jpg" class="pic2 touch-target" alt="Memory Photo" onerror="this.onerror=null; this.src='data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path fill=\"%23ff4f9a\" d=\"M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z\"/></svg>'">
    <img src="pic_three.png" class="touch-target" alt="Another Memory" onerror="this.onerror=null; this.src='data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path fill=\"%23ff4f9a\" d=\"M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z\"/></svg>'">
  </div>
  
  <!-- Message with Typewriter -->
  <div id="letterBox">
    <div id="typingText" class="typing-text"></div>
    <span class="cursor"></span>
  </div>
  
  <div class="mobile-instruction">Swipe to scroll ‚Ä¢ Double tap to skip typing</div>
</div>

<audio id="bgm" src="song.mp3" preload="auto" loop></audio>

<script>
// --- MOBILE OPTIMIZATION VARIABLES ---
let isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
let isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
let isLandscape = window.innerWidth > window.innerHeight;
let touchStartY = 0;
let touchEndY = 0;

// --- GLOBAL ELEMENTS ---
const body = document.body;
const surprisePage = document.getElementById("surprisePage");
const treeStage = document.getElementById("treeStage");
const finalStage = document.getElementById("finalStage");
const envelope = document.getElementById("envelope");
const envelopeContainer = document.getElementById("envelopeContainer");
const bgm = document.getElementById("bgm");
const cake = document.getElementById("cake");
const moodToggle = document.getElementById("moodToggle");
const musicToggle = document.getElementById("musicToggle");
const loading = document.getElementById("loading");
const progressDots = document.querySelectorAll('.dot');
const letterBox = document.getElementById("letterBox");
const typingText = document.getElementById("typingText");
const cursor = document.querySelector(".cursor");
const skipBtn = document.getElementById("skipBtn");
const backBtn = document.getElementById("backBtn");
const memoryCounter = document.getElementById("memoryCounter");
const loveFill = document.getElementById("loveFill");
const loveText = document.getElementById("loveText");
const daysCounter = document.getElementById("daysCounter");
const countdownEl = document.getElementById("countdown");

// --- CANVAS & TREE ELEMENTS ---
const canvas = document.getElementById("treeCanvas");
const ctx = canvas.getContext("2d");
const leafLayer = document.getElementById("treeContainer");
let animationFrameId;
let currentStage = 1;

// --- TYPEWRITER VARIABLES ---
const message = `My sweet Lakshtu üíñ,

You make my world brighter just by being in it.
Your smile, your voice, the way you talk ‚Äî everything feels magical.

Thank you for choosing me, caring for me,
and making my heart feel safe.

On your special day, I want you to know:

‚ú® You are precious beyond words.
‚ú® You are deeply loved.
‚ú® You are my favorite person in the entire world.

May this year bring you all the happiness you deserve,
and may our journey together continue to grow
with love, laughter, and beautiful memories.

Happy Birthday, my love! 
You mean everything to me. üíï

With all my love,
Always and forever...`;

let typingIndex = 0;
let isTyping = false;
let typingTimeout;
let skipTyping = false;

// --- HEART RAIN ---
let heartRainInterval;

// --- MOBILE OPTIMIZATION FUNCTIONS ---
function setupMobileFeatures() {
  // Add touch feedback for all interactive elements
  const touchElements = document.querySelectorAll('.touch-target, #cake, .gallery img');
  touchElements.forEach(el => {
    el.addEventListener('touchstart', function() {
      this.style.opacity = '0.8';
    });
    
    el.addEventListener('touchend', function() {
      this.style.opacity = '1';
    });
  });
  
  // Prevent double-tap zoom
  document.addEventListener('touchstart', function(event) {
    if (event.touches.length > 1) {
      event.preventDefault();
    }
  }, { passive: false });
  
  // Adjust layout for orientation
  window.addEventListener('orientationchange', handleOrientationChange);
  window.addEventListener('resize', handleOrientationChange);
  
  // Enable smooth scrolling on iOS
  if (isIOS) {
    document.body.style.webkitOverflowScrolling = 'touch';
  }
}

function handleOrientationChange() {
  isLandscape = window.innerWidth > window.innerHeight;
  
  // Update canvas size on orientation change
  if (treeStage.classList.contains('active')) {
    resizeCanvas();
    drawTree(true);
  }
}

// --- SURPRISE PAGE FUNCTIONS ---
function startCountdown() {
  let count = 3;
  countdownEl.textContent = count;
  
  const countdownInterval = setInterval(() => {
    count--;
    if (count > 0) {
      countdownEl.textContent = count;
      createSparkle();
    } else {
      clearInterval(countdownInterval);
      countdownEl.textContent = "üéâ";
      setTimeout(() => {
        countdownEl.style.opacity = "0";
      }, 1000);
    }
  }, 1000);
}

function createSparkle() {
  const sparkle = document.createElement('div');
  sparkle.className = 'sparkle';
  sparkle.style.left = Math.random() * 100 + 'vw';
  sparkle.style.top = Math.random() * 100 + 'vh';
  sparkle.style.width = (5 + Math.random() * 8) + 'px';
  sparkle.style.height = sparkle.style.width;
  sparkle.style.background = `hsl(${Math.random() * 60 + 300}, 100%, 70%)`;
  sparkle.style.animationDuration = (0.5 + Math.random() * 1) + 's';
  
  surprisePage.appendChild(sparkle);
  
  setTimeout(() => {
    sparkle.remove();
  }, 1500);
}

function openEnvelope() {
  // Prevent multiple clicks
  if (envelope.classList.contains('open')) return;
  
  // Play open sound
  try {
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    oscillator.frequency.value = 800;
    oscillator.type = 'sine';
    
    gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
    
    oscillator.start(audioContext.currentTime);
    oscillator.stop(audioContext.currentTime + 0.3);
  } catch (e) {
    console.log("Audio not supported");
  }
  
  // Open envelope animation
  envelope.classList.add('open');
  
  // Create more sparkles
  for (let i = 0; i < 15; i++) {
    setTimeout(() => createSparkle(), i * 80);
  }
  
  // Show letter
  setTimeout(() => {
    // Start heart rain
    startHeartRain();
    
    // Show main content after delay
    setTimeout(() => {
      surprisePage.style.animation = 'surpriseReveal 1s ease forwards';
      
      // Show main stages
      setTimeout(() => {
        surprisePage.style.display = 'none';
        treeStage.classList.add('active');
        showBackButton();
        
        // Start music (with user interaction)
        playMusic();
        
        // Start tree animation
        setTimeout(() => {
          initPetals();
          initTree();
        }, 300);
        
        // Preload images
        preloadImages(['pic_one.jpg', 'pic_two.jpg', 'pic_three.png']);
        
        // Update memory counter
        let loadedCount = 0;
        ['pic_one.jpg', 'pic_two.jpg', 'pic_three.png'].forEach((src, index) => {
          const img = new Image();
          img.onload = () => {
            loadedCount++;
            updateMemoryCounter(loadedCount);
            
            // Update love meter
            const lovePercentage = Math.min(100, loadedCount * 33);
            loveFill.style.width = `${lovePercentage}%`;
            loveText.textContent = `Love Level: ${lovePercentage}%`;
          };
          img.src = src;
        });
        
      }, 1000);
    }, 1500);
  }, 800);
}

// --- INITIALIZATION ---
window.addEventListener('load', () => {
  // Setup mobile features first
  setupMobileFeatures();
  
  setTimeout(() => {
    loading.style.opacity = '0';
    setTimeout(() => {
      loading.style.display = 'none';
      startCountdown();
      calculateDaysTogether();
      
      // Add mobile gesture support
      setupMobileGestures();
    }, 500);
  }, 800);
});

// --- MOBILE GESTURE SUPPORT ---
function setupMobileGestures() {
  // Double tap to skip typing
  let lastTap = 0;
  document.addEventListener('touchend', function(event) {
    const currentTime = new Date().getTime();
    const tapLength = currentTime - lastTap;
    
    if (tapLength < 300 && tapLength > 0) {
      // Double tap detected
      if (currentStage === 2 && isTyping) {
        event.preventDefault();
        skipTypingAnimation();
      }
    }
    
    lastTap = currentTime;
  });
  
  // Swipe support for navigation
  document.addEventListener('touchstart', function(event) {
    touchStartY = event.touches[0].clientY;
  }, { passive: true });
  
  document.addEventListener('touchend', function(event) {
    touchEndY = event.changedTouches[0].clientY;
    handleSwipe();
  }, { passive: true });
}

function handleSwipe() {
  const swipeThreshold = 50;
  const swipeDistance = touchEndY - touchStartY;
  
  if (Math.abs(swipeDistance) > swipeThreshold) {
    if (swipeDistance < 0 && currentStage === 2) {
      // Swipe up on final stage - scroll to bottom of letter
      letterBox.scrollTop = letterBox.scrollHeight;
    }
  }
}

// --- DAYS COUNTER ---
function calculateDaysTogether() {
  // Set your relationship start date (YYYY, MM-1, DD)
  const startDate = new Date(2023, 0, 1); // January 1, 2023
  const today = new Date();
  const diffTime = Math.abs(today - startDate);
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  
  // Animate counter
  let current = 0;
  const increment = diffDays / 30;
  const timer = setInterval(() => {
    current += increment;
    if (current >= diffDays) {
      current = diffDays;
      clearInterval(timer);
    }
    daysCounter.textContent = Math.floor(current);
  }, 30);
}

// --- HEART RAIN ---
function startHeartRain() {
  heartRainInterval = setInterval(() => {
    if (Math.random() > 0.7) {
      createHeart();
    }
  }, 400);
}

function createHeart() {
  const heart = document.createElement('div');
  heart.className = 'heart';
  heart.textContent = 'üíñ';
  heart.style.left = Math.random() * window.innerWidth + 'px';
  heart.style.color = `hsl(${Math.random() * 30 + 330}, 100%, 70%)`;
  heart.style.fontSize = (12 + Math.random() * 15) + 'px';
  heart.style.animationDuration = (3 + Math.random() * 4) + 's';
  heart.style.animationDelay = (Math.random() * 2) + 's';
  
  document.body.appendChild(heart);
  
  setTimeout(() => {
    heart.remove();
  }, 5000);
}

// --- CANVAS MANAGEMENT ---
function resizeCanvas() {
  if (canvas.width !== canvas.clientWidth || canvas.height !== canvas.clientHeight) {
    canvas.width = canvas.clientWidth;
    canvas.height = canvas.clientHeight;
    if (treeStage.classList.contains('active')) {
      drawTree(true);
    }
  }
}

window.addEventListener('resize', resizeCanvas);

function drawTree(clearFirst = false) {
  const trunkColor = getComputedStyle(body).getPropertyValue('--tree-trunk').trim();
  const branchColor = getComputedStyle(body).getPropertyValue('--tree-branch').trim();
  
  if (clearFirst) {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
  }

  const w = canvas.width;
  const h = canvas.height;
  const cw = w / 2;

  // Draw Trunk with gradient
  const trunkGradient = ctx.createLinearGradient(cw, h, cw, h * 0.2);
  trunkGradient.addColorStop(0, trunkColor);
  trunkGradient.addColorStop(1, branchColor);
  
  ctx.lineWidth = w * 0.05;
  ctx.strokeStyle = trunkGradient;
  ctx.lineCap = 'round';
  ctx.lineJoin = 'round';
  
  ctx.beginPath();
  ctx.moveTo(cw, h);
  ctx.bezierCurveTo(cw - w * 0.1, h * 0.7, cw - w * 0.05, h * 0.4, cw, h * 0.2);
  ctx.stroke();

  // Draw Branches
  ctx.lineWidth = w * 0.028;
  ctx.strokeStyle = branchColor;
  
  // Left branch
  ctx.beginPath();
  ctx.moveTo(cw, h * 0.2);
  ctx.bezierCurveTo(cw - w * 0.35, h * 0.1, cw - w * 0.15, h * 0.03, cw - w * 0.05, h * 0.15);
  ctx.stroke();

  // Right branch
  ctx.beginPath();
  ctx.moveTo(cw, h * 0.2);
  ctx.bezierCurveTo(cw + w * 0.35, h * 0.1, cw + w * 0.15, h * 0.03, cw + w * 0.05, h * 0.15);
  ctx.stroke();
}

function createLeaves() {
  leafLayer.querySelectorAll('.leaf').forEach(leaf => leaf.remove());
  
  const colors = ["#ff4fa6", "#ff8bd5", "#ff66cc", "#ff99ff", "#ffb3e6"];
  const w = canvas.width;
  const h = canvas.height;
  const cx = w / 2;
  const cy = h * 0.15;
  const maxR = w * 0.35;

  for (let i = 0; i < 100; i++) {
    let leaf = document.createElement("div");
    leaf.className = "leaf";
    leaf.style.background = colors[Math.floor(Math.random() * colors.length)];
    
    let angle = Math.random() * Math.PI * 2;
    let r = maxR * (0.2 + Math.random() * 0.8);
    
    leaf.style.left = (cx + r * Math.cos(angle)) + "px";
    leaf.style.top = (cy + r * Math.sin(angle * 1.1)) + "px";
    
    leaf.style.animationDelay = (Math.random() * 2) + "s";
    leafLayer.appendChild(leaf);
    
    setTimeout(() => {
      leaf.classList.add("grow");
    }, 100 + i * 15);
  }
}

function initPetals() {
  document.querySelectorAll('.petals').forEach(p => p.remove());

  for (let i = 0; i < 25; i++) {
    let p = document.createElement("div");
    p.className = "petals";
    p.style.left = Math.random() * window.innerWidth + "px";
    p.style.background = `hsl(${Math.random() * 30 + 330}, 100%, 70%)`;
    p.style.animationDuration = (2 + Math.random() * 4) + "s";
    p.style.animationDelay = (Math.random() * 3) + "s";
    document.body.appendChild(p);
  }
}

function initTree() {
  if (animationFrameId) {
    cancelAnimationFrame(animationFrameId);
  }
  resizeCanvas();
  drawTree(true);
  createLeaves();
  setTimeout(() => cake.classList.add("show"), 1200);
}

// --- PAGE TRANSITIONS ---
function updateProgress(stage) {
  progressDots.forEach((dot, index) => {
    if (index + 1 <= stage) {
      dot.classList.add('active');
    } else {
      dot.classList.remove('active');
    }
  });
  currentStage = stage;
}

function updateMemoryCounter(count) {
  memoryCounter.textContent = `Memories: ${count}/3`;
  memoryCounter.classList.add('show');
}

function showSkipButton() {
  skipBtn.classList.add('show');
}

function hideSkipButton() {
  skipBtn.classList.remove('show');
}

function showBackButton() {
  backBtn.classList.add('show');
}

function hideBackButton() {
  backBtn.classList.remove('show');
}

// --- ENVELOPE INTERACTION ---
envelopeContainer.onclick = openEnvelope;
envelopeContainer.ontouchstart = function(e) {
  e.preventDefault();
  this.style.transform = 'scale(0.95)';
};

envelopeContainer.ontouchend = function() {
  this.style.transform = 'scale(1)';
  openEnvelope();
};

// --- CAKE CLICK ---
cake.onclick = () => {
  if (!cake.classList.contains('show')) return;
  
  treeStage.classList.remove("active");
  finalStage.classList.add("active");
  updateProgress(2);
  showSkipButton();
  letterBox.classList.add('show');
  
  if (animationFrameId) {
    cancelAnimationFrame(animationFrameId);
  }
  
  // Start typing after a short delay
  setTimeout(() => {
    startTyping();
  }, 800);
}

// --- TYPEWRITER EFFECT ---
function startTyping() {
  if (isTyping) return;
  
  isTyping = true;
  typingIndex = 0;
  typingText.textContent = "";
  cursor.style.display = "inline-block";
  skipTyping = false;
  
  function typeCharacter() {
    if (skipTyping) {
      // Skip to end
      typingText.textContent = message;
      cursor.style.display = "none";
      isTyping = false;
      letterBox.scrollTop = letterBox.scrollHeight;
      hideSkipButton();
      createConfetti();
      return;
    }
    
    if (typingIndex < message.length) {
      // Add current character
      const char = message.charAt(typingIndex);
      typingText.textContent += char;
      
      // Scroll to keep cursor in view
      letterBox.scrollTop = typingText.scrollHeight;
      
      typingIndex++;
      
      // Determine speed based on character (slower for mobile)
      let speed = isMobile ? 60 : 40;
      
      if (char === '\n') speed = isMobile ? 400 : 300;
      else if (char === '.' || char === '!' || char === '?') speed = isMobile ? 250 : 200;
      else if (char === ',') speed = isMobile ? 150 : 100;
      else if (char.match(/\s/)) speed = isMobile ? 80 : 60;
      else speed = (isMobile ? 30 : 20) + Math.random() * 15;
      
      // Continue typing
      typingTimeout = setTimeout(typeCharacter, speed);
    } else {
      // Typing complete
      cursor.style.display = "none";
      isTyping = false;
      hideSkipButton();
      createConfetti();
    }
  }
  
  // Start typing
  typeCharacter();
}

function skipTypingAnimation() {
  skipTyping = true;
  if (typingTimeout) {
    clearTimeout(typingTimeout);
  }
}

// --- DAY/NIGHT MODE TOGGLE ---
let isDayMode = false;

moodToggle.onclick = () => {
  isDayMode = !isDayMode;
  if (isDayMode) {
    body.classList.add('day-mode');
    moodToggle.querySelector('.emoji').textContent = 'üåô';
    moodToggle.querySelector('.text').textContent = 'Night Mode';
  } else {
    body.classList.remove('day-mode');
    moodToggle.querySelector('.emoji').textContent = '‚òÄÔ∏è';
    moodToggle.querySelector('.text').textContent = 'Day Mode';
  }

  // Update tree colors if on tree stage
  if (treeStage.classList.contains('active')) {
    drawTree(true);
  }
};

// --- MUSIC PLAYER ---
let isMusicPlaying = false;

musicToggle.onclick = () => {
  if (isMusicPlaying) {
    bgm.pause();
    musicToggle.innerHTML = 'üîá';
    musicToggle.style.borderColor = 'var(--text-secondary)';
  } else {
    bgm.play().catch(e => console.log("Music play failed:", e));
    musicToggle.innerHTML = 'üéµ';
    musicToggle.style.borderColor = 'var(--accent)';
  }
  isMusicPlaying = !isMusicPlaying;
};

function playMusic() {
  if (!isMusicPlaying && bgm.paused) {
    bgm.volume = 0.5;
    bgm.play().then(() => {
      isMusicPlaying = true;
      musicToggle.innerHTML = 'üéµ';
      musicToggle.style.borderColor = 'var(--accent)';
    }).catch(e => console.log("Autoplay prevented:", e));
  }
}

// --- IMAGE PRELOADING ---
function preloadImages(imageUrls) {
  imageUrls.forEach(url => {
    const img = new Image();
    img.src = url;
  });
}

// --- CONFETTI EFFECT ---
function createConfetti() {
  for (let i = 0; i < 50; i++) {
    let confetti = document.createElement("div");
    confetti.className = "petals";
    confetti.style.left = Math.random() * window.innerWidth + "px";
    confetti.style.background = `hsl(${Math.random() * 360}, 100%, 65%)`;
    confetti.style.animationDuration = (1 + Math.random() * 2) + "s";
    confetti.style.animationDelay = (Math.random() * 1) + "s";
    confetti.style.width = "6px";
    confetti.style.height = "6px";
    confetti.style.borderRadius = "50%";
    document.body.appendChild(confetti);
    
    setTimeout(() => {
      confetti.remove();
    }, 3000);
  }
}

// --- SKIP BUTTON ---
skipBtn.onclick = () => {
  if (isTyping) {
    skipTypingAnimation();
  }
};

// --- BACK BUTTON ---
backBtn.onclick = () => {
  if (currentStage === 2) {
    // Go back to tree stage
    finalStage.classList.remove("active");
    treeStage.classList.add("active");
    updateProgress(1);
    hideSkipButton();
    
    // Restart tree animation
    setTimeout(() => {
      initTree();
    }, 300);
  }
};

// --- KEYBOARD NAVIGATION (for desktop) ---
if (!isMobile) {
  document.addEventListener('keydown', (e) => {
    switch(e.key) {
      case 'Enter':
      case ' ':
        if (surprisePage.style.display !== 'none') {
          openEnvelope();
        } else if (currentStage === 1) {
          cake.click();
        }
        break;
      case 'ArrowLeft':
        backBtn.click();
        break;
      case 'm':
      case 'M':
        moodToggle.click();
        break;
      case 's':
      case 'S':
        if (currentStage === 2 && isTyping) {
          skipTypingAnimation();
        }
        break;
      case 'Escape':
        backBtn.click();
        break;
    }
  });
}

// --- INITIAL SETUP ---
resizeCanvas();
updateProgress(1);

// Auto-resize canvas periodically
setInterval(resizeCanvas, 1000);

// Mobile vibration feedback (if supported)
function vibrate() {
  if (navigator.vibrate && isMobile) {
    navigator.vibrate(50);
  }
}

// Add vibration to interactions
envelopeContainer.addEventListener('click', vibrate);
cake.addEventListener('click', vibrate);
skipBtn.addEventListener('click', vibrate);
</script>
</body>
</html>
