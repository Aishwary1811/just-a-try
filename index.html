<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Happy Birthday Lakshtu üíñ</title>
<link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéÇ</text></svg>">
<style>
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Dancing+Script:wght@400;700&display=swap');

:root {
  /* Night Mode Variables */
  --bg-primary: #0b001a;
  --bg-secondary: #16002e;
  --text-primary: #ffffff;
  --text-secondary: rgba(255, 255, 255, 0.8);
  --accent: #ff4f9a;
  --accent-light: #ff8bd5;
  --peach: #ffb88c;
  --tree-trunk: #ff33cc;
  --tree-branch: #ff66ff;
  --glow-color: #ff4fa6;
  --card-bg: rgba(255, 255, 255, 0.05);
  --transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Day Mode Variables */
.day-mode {
  --bg-primary: #f8f9ff;
  --bg-secondary: #ffffff;
  --text-primary: #2d2d2d;
  --text-secondary: rgba(45, 45, 45, 0.8);
  --accent: #ff4f9a;
  --accent-light: #ff8bd5;
  --peach: #ff9a6c;
  --tree-trunk: #8b4513;
  --tree-branch: #a0522d;
  --glow-color: #ff69b4;
  --card-bg: rgba(255, 255, 255, 0.9);
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  margin: 0;
  font-family: 'Poppins', sans-serif;
  background: var(--bg-primary);
  color: var(--text-primary);
  overflow: hidden;
  transition: var(--transition);
  min-height: 100vh;
  background-image: 
    radial-gradient(circle at 20% 80%, rgba(255, 79, 166, 0.15) 0%, transparent 50%),
    radial-gradient(circle at 80% 20%, rgba(255, 184, 140, 0.1) 0%, transparent 50%);
}

/* Mood Toggle Button */
#moodToggle {
  position: fixed;
  top: 25px;
  right: 25px;
  padding: 12px 20px;
  border: none;
  border-radius: 30px;
  background: var(--card-bg);
  backdrop-filter: blur(10px);
  color: var(--text-primary);
  cursor: pointer;
  font-weight: 600;
  font-size: 0.9rem;
  z-index: 1000;
  transition: var(--transition);
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
  display: flex;
  align-items: center;
  gap: 8px;
}

#moodToggle:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 25px rgba(0, 0, 0, 0.15);
}

#moodToggle:active {
  transform: translateY(0);
}

/* Stages */
.stage {
  display: none;
  width: 100%;
  height: 100vh;
  position: absolute;
  top: 0;
  left: 0;
  justify-content: center;
  align-items: center;
  flex-direction: column;
  opacity: 0;
  transition: opacity 0.8s ease, transform 0.8s ease;
  padding: 20px;
  transform: translateY(20px);
}

.stage.active {
  display: flex;
  opacity: 1;
  transform: translateY(0);
}

/* Envelope Stage */
#page1 h2 {
  font-size: 1.8rem;
  margin-bottom: 40px;
  text-align: center;
  opacity: 0;
  animation: fadeInUp 1s ease 0.5s forwards;
  color: var(--text-primary);
  text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
}

#envelope {
  width: 280px;
  cursor: pointer;
  filter: drop-shadow(0 10px 20px rgba(0, 0, 0, 0.2));
  animation: 
    float 3s ease-in-out infinite,
    gentleGlow 2.5s ease-in-out infinite alternate;
  transition: transform 0.3s ease;
}

#envelope:hover {
  transform: scale(1.05);
}

@keyframes float {
  0%, 100% { transform: translateY(0) rotate(0deg); }
  50% { transform: translateY(-20px) rotate(1deg); }
}

@keyframes gentleGlow {
  0% { filter: drop-shadow(0 10px 20px rgba(0, 0, 0, 0.2)) drop-shadow(0 0 15px var(--glow-color)); }
  100% { filter: drop-shadow(0 10px 20px rgba(0, 0, 0, 0.2)) drop-shadow(0 0 25px var(--glow-color)); }
}

/* Tree Stage */
#treeStage {
  background: var(--bg-primary);
  overflow: hidden;
}

#treeContainer {
  width: 90vw;
  max-width: 550px;
  height: 90vh;
  max-height: 550px;
  position: relative;
  margin-bottom: 40px;
}

#treeCanvas {
  width: 100%;
  height: 100%;
  position: absolute;
  top: 0;
  left: 0;
}

.leaf {
  position: absolute;
  width: 22px;
  height: 22px;
  background: var(--accent);
  transform: translate(-50%, -50%) scale(0) rotate(0deg);
  clip-path: polygon(50% 0%, 61% 7%, 72% 17%, 80% 28%, 85% 40%, 87% 52%, 86% 63%, 82% 72%, 75% 81%, 66% 88%, 56% 93%, 50% 95%, 44% 93%, 34% 88%, 25% 81%, 18% 72%, 14% 63%, 13% 52%, 15% 40%, 20% 28%, 28% 17%, 39% 7%);
  transition: transform 0.8s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.8s ease;
  filter: drop-shadow(0 0 8px var(--glow-color));
  opacity: 0;
}

.leaf.grow {
  transform: translate(-50%, -50%) scale(1) rotate(360deg);
  opacity: 1;
  animation: leafFloat 6s ease-in-out infinite;
}

@keyframes leafFloat {
  0%, 100% { transform: translate(-50%, -50%) scale(1) rotate(360deg) translateY(0); }
  50% { transform: translate(-50%, -50%) scale(1) rotate(360deg) translateY(-8px); }
}

/* Petals */
.petals {
  position: absolute;
  width: 12px;
  height: 12px;
  background: var(--accent);
  border-radius: 50% 0 50% 50%;
  opacity: 0;
  animation: petalFall linear infinite;
  filter: drop-shadow(0 0 6px var(--glow-color));
  z-index: 1;
}

@keyframes petalFall {
  0% {
    transform: translateY(-100px) rotate(0deg) scale(0);
    opacity: 0;
  }
  10% {
    opacity: 1;
    transform: translateY(-80px) rotate(45deg) scale(1);
  }
  90% {
    opacity: 1;
  }
  100% {
    transform: translateY(100vh) rotate(720deg) scale(0);
    opacity: 0;
  }
}

/* Cake */
#cake {
  width: 250px;
  margin-top: 30px;
  transform: scale(0);
  transition: transform 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
  filter: drop-shadow(0 0 30px rgba(255, 255, 255, 0.3));
  cursor: pointer;
  z-index: 10;
  border-radius: 20px;
  opacity: 0;
}

#cake.show {
  transform: scale(1);
  opacity: 1;
  animation: cakeGlow 3s ease-in-out infinite alternate;
}

@keyframes cakeGlow {
  0% { filter: drop-shadow(0 0 20px rgba(255, 255, 255, 0.3)); }
  100% { filter: drop-shadow(0 0 40px rgba(255, 255, 255, 0.5)); }
}

/* Final Stage */
#finalStage {
  flex-direction: column;
  background: linear-gradient(180deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
  overflow-y: auto;
  align-items: center;
  padding-top: 80px;
  padding-bottom: 40px;
}

#finalStage h1 {
  font-size: 2.5rem;
  margin-bottom: 30px;
  text-align: center;
  color: var(--accent);
  font-family: 'Dancing Script', cursive;
  text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
  animation: titleGlow 3s ease-in-out infinite alternate;
}

@keyframes titleGlow {
  0% { text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2); }
  100% { text-shadow: 0 2px 20px var(--glow-color); }
}

.gallery {
  display: flex;
  flex-wrap: wrap;
  gap: 25px;
  justify-content: center;
  margin: 30px 0;
  padding: 0 20px;
  max-width: 1200px;
}

.gallery img {
  width: 280px;
  height: 350px;
  object-fit: cover;
  border-radius: 20px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
  transition: var(--transition);
  cursor: pointer;
  animation: imageFloat 6s ease-in-out infinite;
}

.gallery img:hover {
  transform: translateY(-10px) scale(1.03);
  box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
}

.gallery img.special {
  width: 340px;
  height: 400px;
  animation-delay: -1s;
}

.gallery img.pic2 {
  width: 380px;
  height: 460px;
  object-fit: contain;
  background-color: var(--bg-secondary);
  animation-delay: -2s;
}

@keyframes imageFloat {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-15px); }
}

#letterBox {
  width: 90%;
  max-width: 700px;
  margin: 40px auto;
  padding: 40px;
  font-size: 1.1rem;
  line-height: 1.8;
  background: var(--card-bg);
  backdrop-filter: blur(10px);
  border-radius: 25px;
  white-space: pre-wrap;
  color: var(--text-primary);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.1);
  font-family: 'Poppins', sans-serif;
  position: relative;
  overflow: hidden;
}

#letterBox::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, var(--accent), var(--accent-light));
}

.cursor {
  display: inline-block;
  width: 3px;
  height: 24px;
  background: var(--accent);
  animation: blink 1s infinite;
  margin-left: 4px;
  vertical-align: middle;
}

@keyframes blink {
  0%, 50% { opacity: 1; }
  51%, 100% { opacity: 0; }
}

/* Music Player */
#musicPlayer {
  position: fixed;
  bottom: 25px;
  left: 25px;
  z-index: 1000;
}

#musicToggle {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background: var(--card-bg);
  backdrop-filter: blur(10px);
  border: 2px solid var(--accent);
  color: var(--accent);
  cursor: pointer;
  font-size: 1.2rem;
  transition: var(--transition);
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
}

#musicToggle:hover {
  transform: scale(1.1);
  background: var(--accent);
  color: white;
}

/* Progress Indicator */
.progress-indicator {
  position: fixed;
  top: 25px;
  left: 25px;
  display: flex;
  gap: 10px;
  z-index: 1000;
}

.dot {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  background: var(--text-secondary);
  transition: var(--transition);
}

.dot.active {
  background: var(--accent);
  transform: scale(1.2);
  box-shadow: 0 0 10px var(--glow-color);
}

/* Responsive Design */
@media (max-width: 768px) {
  #envelope {
    width: 220px;
  }
  
  #finalStage h1 {
    font-size: 2rem;
  }
  
  .gallery img {
    width: 90%;
    height: 300px;
  }
  
  .gallery img.special {
    width: 90%;
    height: 350px;
  }
  
  .gallery img.pic2 {
    width: 90%;
    height: 400px;
  }
  
  #letterBox {
    padding: 25px;
    font-size: 1rem;
  }
  
  #moodToggle {
    top: 15px;
    right: 15px;
    padding: 10px 15px;
    font-size: 0.8rem;
  }
}

@media (max-width: 480px) {
  #page1 h2 {
    font-size: 1.4rem;
  }
  
  #finalStage h1 {
    font-size: 1.8rem;
  }
  
  .gallery {
    gap: 15px;
  }
  
  .gallery img {
    height: 250px;
  }
  
  .gallery img.special {
    height: 300px;
  }
  
  .gallery img.pic2 {
    height: 350px;
  }
}

/* Loading Screen */
#loading {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: var(--bg-primary);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  transition: opacity 0.5s ease;
}

.loader {
  width: 60px;
  height: 60px;
  border: 4px solid var(--card-bg);
  border-top: 4px solid var(--accent);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>
</head>
<body class="night-mode">

<!-- Loading Screen -->
<div id="loading">
  <div class="loader"></div>
</div>

<!-- Progress Indicator -->
<div class="progress-indicator">
  <div class="dot active" data-stage="1"></div>
  <div class="dot" data-stage="2"></div>
  <div class="dot" data-stage="3"></div>
</div>

<!-- Mood Toggle -->
<button id="moodToggle" title="Toggle Day/Night Mode">
  <span class="emoji">‚òÄÔ∏è</span>
  <span class="text">Day Mode</span>
</button>

<!-- Music Player -->
<div id="musicPlayer">
  <button id="musicToggle" title="Toggle Music">üéµ</button>
</div>

<!-- Stage 1: Envelope -->
<div id="page1" class="stage active">
  <h2>Tap the envelope to begin üíå</h2>
  <img src="envelope.png" id="envelope" alt="Envelope" onerror="this.onerror=null; this.src='data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path fill=\"%23ff4f9a\" d=\"M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H4V8l8 5 8-5v10zm-8-7L4 6h16l-8 5z\"/></svg>'">
</div>

<!-- Stage 2: Tree -->
<div id="treeStage" class="stage">
  <div id="treeContainer">
    <canvas id="treeCanvas"></canvas>
  </div>
  <img src="cake.jpg" id="cake" alt="Birthday Cake" onerror="this.onerror=null; this.src='data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path fill=\"%23ff4f9a\" d=\"M12 6a2 2 0 002-2c0-.38-.1-.73-.29-1.03L12 0l-1.71 2.97c-.19.3-.29.65-.29 1.03 0 1.1.9 2 2 2zm4.6 9.99l-1.07-1.07-1.08 1.07c-1.3 1.3-3.58 1.31-4.89 0L8.47 14.92 7.4 16c-1.3 1.3-3.58 1.31-4.89 0-.39-.39-.39-1.02 0-1.41l1.07-1.07-1.07-1.07c-.39-.39-.39-1.02 0-1.41.39-.39 1.02-.39 1.41 0l1.07 1.07 1.07-1.07c.39-.39 1.02-.39 1.41 0 .39.39.39 1.02 0 1.41l-1.07 1.07 1.07 1.07c.39.39.39 1.02 0 1.41zM18 9h-5V7h-2v2H6c-1.66 0-3 1.34-3 3v1.54c0 1.08.88 1.96 1.96 1.96.52 0 1.02-.2 1.38-.57l2.14-2.13 2.13 2.13c.74.74 2.03.74 2.77 0l2.14-2.13 2.13 2.13c.37.37.86.57 1.38.57 1.08 0 1.96-.88 1.96-1.96V12C21 10.34 19.66 9 18 9z\"/></svg>'">
</div>

<!-- Stage 3: Memories & Letter -->
<div id="finalStage" class="stage">
  <h1>Our Beautiful Memories üíó</h1>
  <div class="gallery">
    <img src="pic_one.jpg" class="special" alt="Special Memory" onerror="this.onerror=null; this.src='data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path fill=\"%23ff4f9a\" d=\"M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z\"/></svg>'">
    <img src="pic_two.jpg" class="pic2" alt="Memory Photo" onerror="this.onerror=null; this.src='data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path fill=\"%23ff4f9a\" d=\"M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z\"/></svg>'">
    <img src="pic_three.png" alt="Another Memory" onerror="this.onerror=null; this.src='data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path fill=\"%23ff4f9a\" d=\"M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z\"/></svg>'">
  </div>
  <div id="letterBox"></div><span class="cursor"></span>
</div>

<audio id="bgm" src="song.mp3" preload="auto" loop></audio>

<script>
// --- GLOBAL ELEMENTS ---
const body = document.body;
const page1 = document.getElementById("page1");
const page2 = document.getElementById("treeStage");
const finalStage = document.getElementById("finalStage");
const envelope = document.getElementById("envelope");
const bgm = document.getElementById("bgm");
const cake = document.getElementById("cake");
const moodToggle = document.getElementById("moodToggle");
const musicToggle = document.getElementById("musicToggle");
const loading = document.getElementById("loading");
const progressDots = document.querySelectorAll('.dot');

// --- CANVAS & TREE ELEMENTS ---
const canvas = document.getElementById("treeCanvas");
const ctx = canvas.getContext("2d");
const leafLayer = document.getElementById("treeContainer");
let animationFrameId;
let currentStage = 1;

// --- INITIALIZATION ---
window.addEventListener('load', () => {
  setTimeout(() => {
    loading.style.opacity = '0';
    setTimeout(() => {
      loading.style.display = 'none';
    }, 500);
  }, 1000);
});

// --- CANVAS MANAGEMENT ---
function resizeCanvas() {
  if (canvas.width !== canvas.clientWidth || canvas.height !== canvas.clientHeight) {
    canvas.width = canvas.clientWidth;
    canvas.height = canvas.clientHeight;
    if (page2.classList.contains('active')) {
      drawTree(true);
    }
  }
}

window.addEventListener('resize', resizeCanvas);

function drawTree(clearFirst = false) {
  const trunkColor = getComputedStyle(body).getPropertyValue('--tree-trunk').trim();
  const branchColor = getComputedStyle(body).getPropertyValue('--tree-branch').trim();
  
  if (clearFirst) {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
  }

  const w = canvas.width;
  const h = canvas.height;
  const cw = w / 2;

  // Draw Trunk with gradient
  const trunkGradient = ctx.createLinearGradient(cw, h, cw, h * 0.2);
  trunkGradient.addColorStop(0, trunkColor);
  trunkGradient.addColorStop(1, branchColor);
  
  ctx.lineWidth = w * 0.05;
  ctx.strokeStyle = trunkGradient;
  ctx.lineCap = 'round';
  ctx.lineJoin = 'round';
  
  ctx.beginPath();
  ctx.moveTo(cw, h);
  ctx.bezierCurveTo(cw - w * 0.1, h * 0.7, cw - w * 0.05, h * 0.4, cw, h * 0.2);
  ctx.stroke();

  // Draw Branches
  ctx.lineWidth = w * 0.028;
  ctx.strokeStyle = branchColor;
  
  // Left branch
  ctx.beginPath();
  ctx.moveTo(cw, h * 0.2);
  ctx.bezierCurveTo(cw - w * 0.35, h * 0.1, cw - w * 0.15, h * 0.03, cw - w * 0.05, h * 0.15);
  ctx.stroke();

  // Right branch
  ctx.beginPath();
  ctx.moveTo(cw, h * 0.2);
  ctx.bezierCurveTo(cw + w * 0.35, h * 0.1, cw + w * 0.15, h * 0.03, cw + w * 0.05, h * 0.15);
  ctx.stroke();
}

function createLeaves() {
  leafLayer.querySelectorAll('.leaf').forEach(leaf => leaf.remove());
  
  const colors = ["#ff4fa6", "#ff8bd5", "#ff66cc", "#ff99ff", "#ffb3e6"];
  const w = canvas.width;
  const h = canvas.height;
  const cx = w / 2;
  const cy = h * 0.15;
  const maxR = w * 0.35;

  for (let i = 0; i < 150; i++) {
    let leaf = document.createElement("div");
    leaf.className = "leaf";
    leaf.style.background = colors[Math.floor(Math.random() * colors.length)];
    
    let angle = Math.random() * Math.PI * 2;
    let r = maxR * (0.2 + Math.random() * 0.8);
    
    leaf.style.left = (cx + r * Math.cos(angle)) + "px";
    leaf.style.top = (cy + r * Math.sin(angle * 1.1)) + "px";
    
    leaf.style.animationDelay = (Math.random() * 2) + "s";
    leafLayer.appendChild(leaf);
    
    setTimeout(() => {
      leaf.classList.add("grow");
    }, 100 + i * 10);
  }
}

function initPetals() {
  document.querySelectorAll('.petals').forEach(p => p.remove());

  for (let i = 0; i < 40; i++) {
    let p = document.createElement("div");
    p.className = "petals";
    p.style.left = Math.random() * window.innerWidth + "px";
    p.style.background = `hsl(${Math.random() * 30 + 330}, 100%, 70%)`;
    p.style.animationDuration = (2 + Math.random() * 4) + "s";
    p.style.animationDelay = (Math.random() * 3) + "s";
    document.body.appendChild(p);
  }
}

function initTree() {
  if (animationFrameId) {
    cancelAnimationFrame(animationFrameId);
  }
  resizeCanvas();
  drawTree(true);
  createLeaves();
  setTimeout(() => cake.classList.add("show"), 1500);
}

// --- PAGE TRANSITIONS ---
function updateProgress(stage) {
  progressDots.forEach((dot, index) => {
    if (index + 1 <= stage) {
      dot.classList.add('active');
    } else {
      dot.classList.remove('active');
    }
  });
  currentStage = stage;
}

envelope.onclick = () => {
  bgm.play().catch(e => console.log("Autoplay prevented:", e));
  page1.classList.remove("active");
  page2.classList.add("active");
  updateProgress(2);
  
  // Start animations
  setTimeout(() => {
    initPetals();
    initTree();
  }, 300);
  
  // Preload next stage images
  preloadImages(['pic_one.jpg', 'pic_two.jpg', 'pic_three.png']);
}

cake.onclick = () => {
  page2.classList.remove("active");
  finalStage.classList.add("active");
  updateProgress(3);
  
  if (animationFrameId) {
    cancelAnimationFrame(animationFrameId);
  }
  
  startTyping();
}

// --- TYPEWRITER ---
let message = `My sweet Lakshtu üíñ,

You make my world brighter just by being in it.
Your smile, your voice, the way you talk ‚Äî everything feels magical.

Thank you for choosing me, caring for me,
and making my heart feel safe.

On your special day, I want you to know:

‚ú® You are precious beyond words.
‚ú® You are deeply loved.
‚ú® You are my favorite person in the entire world.

May this year bring you all the happiness you deserve,
and may our journey together continue to grow
with love, laughter, and beautiful memories.

Happy Birthday, my love! 
You mean everything to me. üíï

With all my love,
Always and forever...`;

let typingSpeed = 26 + Math.random() * 18;
let i = 0;

function startTyping() {
  const letterBox = document.getElementById("letterBox");
  const cursor = document.querySelector(".cursor");
  letterBox.textContent = "";
  i = 0;
  cursor.style.display = "inline-block";
  
  function step() {
    if (i < message.length) {
      letterBox.textContent += message[i];
      i++;
      
      // Add slight speed variation for natural feel
      typingSpeed = 24 + Math.random() * 20;
      setTimeout(step, typingSpeed);
    } else {
      cursor.style.display = "none";
      // Add confetti effect when typing completes
      createConfetti();
    }
  }
  step();
}

// --- DAY/NIGHT MODE TOGGLE ---
let isDayMode = false;

moodToggle.onclick = () => {
  isDayMode = !isDayMode;
  if (isDayMode) {
    body.classList.add('day-mode');
    moodToggle.querySelector('.emoji').textContent = 'üåô';
    moodToggle.querySelector('.text').textContent = 'Night Mode';
  } else {
    body.classList.remove('day-mode');
    moodToggle.querySelector('.emoji').textContent = '‚òÄÔ∏è';
    moodToggle.querySelector('.text').textContent = 'Day Mode';
  }

  // Update tree colors if on tree stage
  if (page2.classList.contains('active')) {
    drawTree(true);
  }
};

// --- MUSIC PLAYER ---
let isMusicPlaying = false;

musicToggle.onclick = () => {
  if (isMusicPlaying) {
    bgm.pause();
    musicToggle.innerHTML = 'üîá';
    musicToggle.style.borderColor = 'var(--text-secondary)';
  } else {
    bgm.play().catch(e => console.log("Music play failed:", e));
    musicToggle.innerHTML = 'üéµ';
    musicToggle.style.borderColor = 'var(--accent)';
  }
  isMusicPlaying = !isMusicPlaying;
};

// Auto-play music on first interaction
document.addEventListener('click', () => {
  if (!isMusicPlaying && bgm.paused) {
    bgm.play().then(() => {
      isMusicPlaying = true;
      musicToggle.innerHTML = 'üéµ';
      musicToggle.style.borderColor = 'var(--accent)';
    }).catch(e => console.log("Autoplay prevented:", e));
  }
}, { once: true });

// --- IMAGE PRELOADING ---
function preloadImages(imageUrls) {
  imageUrls.forEach(url => {
    const img = new Image();
    img.src = url;
  });
}

// --- CONFETTI EFFECT ---
function createConfetti() {
  for (let i = 0; i < 50; i++) {
    let confetti = document.createElement("div");
    confetti.className = "petals";
    confetti.style.left = Math.random() * window.innerWidth + "px";
    confetti.style.background = `hsl(${Math.random() * 360}, 100%, 65%)`;
    confetti.style.animationDuration = (1 + Math.random() * 2) + "s";
    confetti.style.animationDelay = (Math.random() * 1) + "s";
    confetti.style.width = "8px";
    confetti.style.height = "8px";
    document.body.appendChild(confetti);
    
    setTimeout(() => {
      confetti.remove();
    }, 3000);
  }
}

// --- KEYBOARD NAVIGATION ---
document.addEventListener('keydown', (e) => {
  switch(e.key) {
    case 'ArrowRight':
    case ' ':
      if (currentStage === 1) envelope.click();
      else if (currentStage === 2) cake.click();
      break;
    case 'ArrowLeft':
      // Go back to previous stage
      break;
    case 'm':
    case 'M':
      moodToggle.click();
      break;
    case ' ':
      if (e.target === body) {
        musicToggle.click();
      }
      break;
  }
});

// --- INITIAL SETUP ---
resizeCanvas();
updateProgress(1);

// Auto-resize canvas periodically
setInterval(resizeCanvas, 1000);
</script>
</body>
</html>
