<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Happy Birthday Lakshtu üíñ</title>
<link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéÇ</text></svg>">
<style>
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Dancing+Script:wght@400;700&display=swap');

:root {
  /* Night Mode Variables */
  --bg-primary: #0b001a;
  --bg-secondary: #16002e;
  --text-primary: #ffffff;
  --text-secondary: rgba(255, 255, 255, 0.8);
  --accent: #ff4f9a;
  --accent-light: #ff8bd5;
  --peach: #ffb88c;
  --tree-trunk: #ff33cc;
  --tree-branch: #ff66ff;
  --glow-color: #ff4fa6;
  --card-bg: rgba(255, 255, 255, 0.05);
  --transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Day Mode Variables */
.day-mode {
  --bg-primary: #f8f9ff;
  --bg-secondary: #ffffff;
  --text-primary: #2d2d2d;
  --text-secondary: rgba(45, 45, 45, 0.8);
  --accent: #ff4f9a;
  --accent-light: #ff8bd5;
  --peach: #ff9a6c;
  --tree-trunk: #8b4513;
  --tree-branch: #a0522d;
  --glow-color: #ff69b4;
  --card-bg: rgba(255, 255, 255, 0.9);
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  margin: 0;
  font-family: 'Poppins', sans-serif;
  background: var(--bg-primary);
  color: var(--text-primary);
  overflow: hidden;
  transition: var(--transition);
  min-height: 100vh;
  background-image: 
    radial-gradient(circle at 20% 80%, rgba(255, 79, 166, 0.15) 0%, transparent 50%),
    radial-gradient(circle at 80% 20%, rgba(255, 184, 140, 0.1) 0%, transparent 50%);
}

/* Mood Toggle Button */
#moodToggle {
  position: fixed;
  top: 25px;
  right: 25px;
  padding: 12px 20px;
  border: none;
  border-radius: 30px;
  background: var(--card-bg);
  backdrop-filter: blur(10px);
  color: var(--text-primary);
  cursor: pointer;
  font-weight: 600;
  font-size: 0.9rem;
  z-index: 1000;
  transition: var(--transition);
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
  display: flex;
  align-items: center;
  gap: 8px;
}

#moodToggle:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 25px rgba(0, 0, 0, 0.15);
}

#moodToggle:active {
  transform: translateY(0);
}

/* Stages */
.stage {
  display: none;
  width: 100%;
  height: 100vh;
  position: absolute;
  top: 0;
  left: 0;
  justify-content: center;
  align-items: center;
  flex-direction: column;
  opacity: 0;
  transition: opacity 0.8s ease, transform 0.8s ease;
  padding: 20px;
  transform: translateY(20px);
}

.stage.active {
  display: flex;
  opacity: 1;
  transform: translateY(0);
}

/* Envelope Stage */
#page1 h2 {
  font-size: 1.8rem;
  margin-bottom: 40px;
  text-align: center;
  opacity: 0;
  animation: fadeInUp 1s ease 0.5s forwards;
  color: var(--text-primary);
  text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
}

#envelope {
  width: 280px;
  cursor: pointer;
  filter: drop-shadow(0 10px 20px rgba(0, 0, 0, 0.2));
  animation: 
    float 3s ease-in-out infinite,
    gentleGlow 2.5s ease-in-out infinite alternate;
  transition: transform 0.3s ease;
}

#envelope:hover {
  transform: scale(1.05);
}

@keyframes float {
  0%, 100% { transform: translateY(0) rotate(0deg); }
  50% { transform: translateY(-20px) rotate(1deg); }
}

@keyframes gentleGlow {
  0% { filter: drop-shadow(0 10px 20px rgba(0, 0, 0, 0.2)) drop-shadow(0 0 15px var(--glow-color)); }
  100% { filter: drop-shadow(0 10px 20px rgba(0, 0, 0, 0.2)) drop-shadow(0 0 25px var(--glow-color)); }
}

/* Tree Stage */
#treeStage {
  background: var(--bg-primary);
  overflow: hidden;
}

#treeContainer {
  width: 90vw;
  max-width: 550px;
  height: 90vh;
  max-height: 550px;
  position: relative;
  margin-bottom: 40px;
}

#treeCanvas {
  width: 100%;
  height: 100%;
  position: absolute;
  top: 0;
  left: 0;
}

.leaf {
  position: absolute;
  width: 22px;
  height: 22px;
  background: var(--accent);
  transform: translate(-50%, -50%) scale(0) rotate(0deg);
  clip-path: polygon(50% 0%, 61% 7%, 72% 17%, 80% 28%, 85% 40%, 87% 52%, 86% 63%, 82% 72%, 75% 81%, 66% 88%, 56% 93%, 50% 95%, 44% 93%, 34% 88%, 25% 81%, 18% 72%, 14% 63%, 13% 52%, 15% 40%, 20% 28%, 28% 17%, 39% 7%);
  transition: transform 0.8s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.8s ease;
  filter: drop-shadow(0 0 8px var(--glow-color));
  opacity: 0;
}

.leaf.grow {
  transform: translate(-50%, -50%) scale(1) rotate(360deg);
  opacity: 1;
  animation: leafFloat 6s ease-in-out infinite;
}

@keyframes leafFloat {
  0%, 100% { transform: translate(-50%, -50%) scale(1) rotate(360deg) translateY(0); }
  50% { transform: translate(-50%, -50%) scale(1) rotate(360deg) translateY(-8px); }
}

/* Petals */
.petals {
  position: absolute;
  width: 12px;
  height: 12px;
  background: var(--accent);
  border-radius: 50% 0 50% 50%;
  opacity: 0;
  animation: petalFall linear infinite;
  filter: drop-shadow(0 0 6px var(--glow-color));
  z-index: 1;
}

@keyframes petalFall {
  0% {
    transform: translateY(-100px) rotate(0deg) scale(0);
    opacity: 0;
  }
  10% {
    opacity: 1;
    transform: translateY(-80px) rotate(45deg) scale(1);
  }
  90% {
    opacity: 1;
  }
  100% {
    transform: translateY(100vh) rotate(720deg) scale(0);
    opacity: 0;
  }
}

/* Cake */
#cake {
  width: 250px;
  margin-top: 30px;
  transform: scale(0);
  transition: transform 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
  filter: drop-shadow(0 0 30px rgba(255, 255, 255, 0.3));
  cursor: pointer;
  z-index: 10;
  border-radius: 20px;
  opacity: 0;
}

#cake.show {
  transform: scale(1);
  opacity: 1;
  animation: cakeGlow 3s ease-in-out infinite alternate;
}

@keyframes cakeGlow {
  0% { filter: drop-shadow(0 0 20px rgba(255, 255, 255, 0.3)); }
  100% { filter: drop-shadow(0 0 40px rgba(255, 255, 255, 0.5)); }
}

/* Final Stage */
#finalStage {
  flex-direction: column;
  background: linear-gradient(180deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
  overflow-y: auto;
  align-items: center;
  padding-top: 80px;
  padding-bottom: 40px;
}

#finalStage h1 {
  font-size: 2.5rem;
  margin-bottom: 30px;
  text-align: center;
  color: var(--accent);
  font-family: 'Dancing Script', cursive;
  text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
  animation: titleGlow 3s ease-in-out infinite alternate;
}

@keyframes titleGlow {
  0% { text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2); }
  100% { text-shadow: 0 2px 20px var(--glow-color); }
}

.gallery {
  display: flex;
  flex-wrap: wrap;
  gap: 25px;
  justify-content: center;
  margin: 30px 0;
  padding: 0 20px;
  max-width: 1200px;
}

.gallery img {
  width: 280px;
  height: 350px;
  object-fit: cover;
  border-radius: 20px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
  transition: var(--transition);
  cursor: pointer;
  animation: imageFloat 6s ease-in-out infinite;
}

.gallery img:hover {
  transform: translateY(-10px) scale(1.03);
  box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
}

.gallery img.special {
  width: 340px;
  height: 400px;
  animation-delay: -1s;
}

.gallery img.pic2 {
  width: 380px;
  height: 460px;
  object-fit: contain;
  background-color: var(--bg-secondary);
  animation-delay: -2s;
}

@keyframes imageFloat {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-15px); }
}

/* Letter Box Styles */
#letterBox {
  width: 90%;
  max-width: 700px;
  margin: 40px auto;
  padding: 40px;
  font-size: 1.1rem;
  line-height: 1.8;
  background: var(--card-bg);
  backdrop-filter: blur(10px);
  border-radius: 25px;
  color: var(--text-primary);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.1);
  font-family: 'Poppins', sans-serif;
  position: relative;
  overflow: hidden;
  min-height: 300px;
  opacity: 0;
  transform: translateY(20px);
  transition: opacity 0.8s ease, transform 0.8s ease;
}

#letterBox.show {
  opacity: 1;
  transform: translateY(0);
}

#letterBox::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, var(--accent), var(--accent-light));
}

/* Typewriter Styles */
.typing-text {
  display: inline;
}

.cursor {
  display: inline-block;
  width: 3px;
  height: 24px;
  background: var(--accent);
  animation: blink 1s infinite;
  margin-left: 2px;
  vertical-align: middle;
}

@keyframes blink {
  0%, 50% { opacity: 1; }
  51%, 100% { opacity: 0; }
}

/* Skip Button */
.skip-btn {
  position: fixed;
  bottom: 100px;
  right: 30px;
  padding: 12px 20px;
  background: var(--accent);
  color: white;
  border: none;
  border-radius: 25px;
  cursor: pointer;
  font-weight: 600;
  font-size: 0.9rem;
  z-index: 1000;
  opacity: 0;
  transform: translateY(20px);
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(255, 79, 166, 0.3);
}

.skip-btn.show {
  opacity: 1;
  transform: translateY(0);
}

.skip-btn:hover {
  background: var(--accent-light);
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(255, 79, 166, 0.4);
}

/* Back Button */
.back-btn {
  position: fixed;
  top: 25px;
  left: 25px;
  padding: 10px 15px;
  background: var(--card-bg);
  color: var(--text-primary);
  border: none;
  border-radius: 20px;
  cursor: pointer;
  font-weight: 600;
  font-size: 0.8rem;
  z-index: 1000;
  opacity: 0;
  transition: all 0.3s ease;
  backdrop-filter: blur(10px);
}

.back-btn.show {
  opacity: 1;
}

.back-btn:hover {
  background: var(--accent);
  color: white;
}

/* Love Meter */
.love-meter {
  width: 200px;
  height: 20px;
  background: var(--card-bg);
  border-radius: 10px;
  margin: 20px auto;
  overflow: hidden;
  position: relative;
}

.love-fill {
  position: absolute;
  height: 100%;
  background: linear-gradient(90deg, var(--accent), var(--accent-light));
  border-radius: 10px;
  transition: width 1s ease;
  width: 0%;
}

.love-text {
  position: absolute;
  width: 100%;
  text-align: center;
  font-size: 0.8rem;
  font-weight: 600;
  line-height: 20px;
  color: white;
  z-index: 2;
}

/* Memory Counter */
.memory-counter {
  position: fixed;
  top: 25px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--card-bg);
  padding: 8px 16px;
  border-radius: 20px;
  font-size: 0.9rem;
  font-weight: 600;
  backdrop-filter: blur(10px);
  z-index: 1000;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.memory-counter.show {
  opacity: 1;
}

/* Heart Rain */
.heart {
  position: absolute;
  font-size: 20px;
  animation: heartFall linear infinite;
  opacity: 0;
  z-index: 0;
}

@keyframes heartFall {
  0% {
    transform: translateY(-50px) rotate(0deg) scale(0);
    opacity: 0;
  }
  10% {
    opacity: 1;
    transform: translateY(-30px) rotate(0deg) scale(1);
  }
  90% {
    opacity: 1;
  }
  100% {
    transform: translateY(100vh) rotate(360deg) scale(0);
    opacity: 0;
  }
}

/* Date Counter */
.date-counter {
  background: var(--card-bg);
  padding: 20px 30px;
  border-radius: 20px;
  text-align: center;
  margin: 20px 0;
  backdrop-filter: blur(10px);
}

.date-counter h3 {
  color: var(--accent);
  margin-bottom: 10px;
  font-size: 1.2rem;
}

.date-number {
  font-size: 2.5rem;
  font-weight: 700;
  color: var(--accent);
  text-shadow: 0 0 10px var(--glow-color);
}

.date-label {
  font-size: 0.9rem;
  color: var(--text-secondary);
  margin-top: 5px;
}

/* Music Player */
#musicPlayer {
  position: fixed;
  bottom: 25px;
  left: 25px;
  z-index: 1000;
}

#musicToggle {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background: var(--card-bg);
  backdrop-filter: blur(10px);
  border: 2px solid var(--accent);
  color: var(--accent);
  cursor: pointer;
  font-size: 1.2rem;
  transition: var(--transition);
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
}

#musicToggle:hover {
  transform: scale(1.1);
  background: var(--accent);
  color: white;
}

/* Progress Indicator */
.progress-indicator {
  position: fixed;
  top: 25px;
  left: 25px;
  display: flex;
  gap: 10px;
  z-index: 1000;
}

.dot {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  background: var(--text-secondary);
  transition: var(--transition);
}

.dot.active {
  background: var(--accent);
  transform: scale(1.2);
  box-shadow: 0 0 10px var(--glow-color);
}

/* Responsive Design */
@media (max-width: 768px) {
  #envelope {
    width: 220px;
  }
  
  #finalStage h1 {
    font-size: 2rem;
  }
  
  .gallery img {
    width: 90%;
    height: 300px;
  }
  
  .gallery img.special {
    width: 90%;
    height: 350px;
  }
  
  .gallery img.pic2 {
    width: 90%;
    height: 400px;
  }
  
  #letterBox {
    padding: 25px;
    font-size: 1rem;
  }
  
  #moodToggle {
    top: 15px;
    right: 15px;
    padding: 10px 15px;
    font-size: 0.8rem;
  }
  
  .skip-btn {
    bottom: 80px;
    right: 20px;
    padding: 10px 16px;
    font-size: 0.8rem;
  }
}

@media (max-width: 480px) {
  #page1 h2 {
    font-size: 1.4rem;
  }
  
  #finalStage h1 {
    font-size: 1.8rem;
  }
  
  .gallery {
    gap: 15px;
  }
  
  .gallery img {
    height: 250px;
  }
  
  .gallery img.special {
    height: 300px;
  }
  
  .gallery img.pic2 {
    height: 350px;
  }
  
  .date-number {
    font-size: 2rem;
  }
}

/* Loading Screen */
#loading {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: var(--bg-primary);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  transition: opacity 0.5s ease;
}

.loader {
  width: 60px;
  height: 60px;
  border: 4px solid var(--card-bg);
  border-top: 4px solid var(--accent);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Tap Instruction */
.tap-instruction {
  position: absolute;
  bottom: 30px;
  text-align: center;
  font-size: 1rem;
  color: var(--text-secondary);
  opacity: 0.8;
  animation: pulse 2s infinite;
  width: 100%;
}

@keyframes pulse {
  0%, 100% { opacity: 0.5; }
  50% { opacity: 1; }
}
</style>
</head>
<body class="night-mode">

<!-- Loading Screen -->
<div id="loading">
  <div class="loader"></div>
</div>

<!-- Progress Indicator -->
<div class="progress-indicator">
  <div class="dot active" data-stage="1"></div>
  <div class="dot" data-stage="2"></div>
  <div class="dot" data-stage="3"></div>
</div>

<!-- Back Button -->
<button class="back-btn" id="backBtn">‚Üê Back</button>

<!-- Memory Counter -->
<div class="memory-counter" id="memoryCounter">Memories: 0/3</div>

<!-- Mood Toggle -->
<button id="moodToggle" title="Toggle Day/Night Mode">
  <span class="emoji">‚òÄÔ∏è</span>
  <span class="text">Day Mode</span>
</button>

<!-- Music Player -->
<div id="musicPlayer">
  <button id="musicToggle" title="Toggle Music">üéµ</button>
</div>

<!-- Skip Button -->
<button class="skip-btn" id="skipBtn">Skip Animation ‚è©</button>

<!-- Stage 1: Envelope -->
<div id="page1" class="stage active">
  <h2>Tap the envelope to begin üíå</h2>
  <img src="envelope.png" id="envelope" alt="Envelope" onerror="this.onerror=null; this.src='data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path fill=\"%23ff4f9a\" d=\"M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H4V8l8 5 8-5v10zm-8-7L4 6h16l-8 5z\"/></svg>'">
  <div class="tap-instruction">Tap anywhere to continue</div>
</div>

<!-- Stage 2: Tree -->
<div id="treeStage" class="stage">
  <div id="treeContainer">
    <canvas id="treeCanvas"></canvas>
  </div>
  <img src="cake.jpg" id="cake" alt="Birthday Cake" onerror="this.onerror=null; this.src='data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path fill=\"%23ff4f9a\" d=\"M12 6a2 2 0 002-2c0-.38-.1-.73-.29-1.03L12 0l-1.71 2.97c-.19.3-.29.65-.29 1.03 0 1.1.9 2 2 2zm4.6 9.99l-1.07-1.07-1.08 1.07c-1.3 1.3-3.58 1.31-4.89 0L8.47 14.92 7.4 16c-1.3 1.3-3.58 1.31-4.89 0-.39-.39-.39-1.02 0-1.41l1.07-1.07-1.07-1.07c-.39-.39-.39-1.02 0-1.41.39-.39 1.02-.39 1.41 0l1.07 1.07 1.07-1.07c.39-.39 1.02-.39 1.41 0 .39.39.39 1.02 0 1.41l-1.07 1.07 1.07 1.07c.39.39.39 1.02 0 1.41zM18 9h-5V7h-2v2H6c-1.66 0-3 1.34-3 3v1.54c0 1.08.88 1.96 1.96 1.96.52 0 1.02-.2 1.38-.57l2.14-2.13 2.13 2.13c.74.74 2.03.74 2.77 0l2.14-2.13 2.13 2.13c.37.37.86.57 1.38.57 1.08 0 1.96-.88 1.96-1.96V12C21 10.34 19.66 9 18 9z\"/></svg>'">
  <div class="tap-instruction">Tap the cake to continue</div>
</div>

<!-- Stage 3: Memories & Letter -->
<div id="finalStage" class="stage">
  <h1>Our Beautiful Memories üíó</h1>
  
  <!-- Love Meter -->
  <div class="love-meter">
    <div class="love-fill" id="loveFill"></div>
    <div class="love-text" id="loveText">Love Level: 0%</div>
  </div>
  
  <!-- Date Counter -->
  <div class="date-counter">
    <h3>Days Together</h3>
    <div class="date-number" id="daysCounter">0</div>
    <div class="date-label">and counting...</div>
  </div>
  
  <div class="gallery">
    <img src="pic_one.jpg" class="special" alt="Special Memory" onerror="this.onerror=null; this.src='data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path fill=\"%23ff4f9a\" d=\"M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z\"/></svg>'">
    <img src="pic_two.jpg" class="pic2" alt="Memory Photo" onerror="this.onerror=null; this.src='data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path fill=\"%23ff4f9a\" d=\"M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z\"/></svg>'">
    <img src="pic_three.png" alt="Another Memory" onerror="this.onerror=null; this.src='data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path fill=\"%23ff4f9a\" d=\"M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z\"/></svg>'">
  </div>
  
  <!-- Message with Typewriter -->
  <div id="letterBox">
    <div id="typingText" class="typing-text"></div>
    <span class="cursor"></span>
  </div>
  
  <div class="tap-instruction">Scroll to read the full message</div>
</div>

<audio id="bgm" src="song.mp3" preload="auto" loop></audio>
<audio id="typeSound" preload="auto">
  <source src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA=" type="audio/wav">
</audio>

<script>
// --- GLOBAL ELEMENTS ---
const body = document.body;
const page1 = document.getElementById("page1");
const page2 = document.getElementById("treeStage");
const finalStage = document.getElementById("finalStage");
const envelope = document.getElementById("envelope");
const bgm = document.getElementById("bgm");
const cake = document.getElementById("cake");
const moodToggle = document.getElementById("moodToggle");
const musicToggle = document.getElementById("musicToggle");
const loading = document.getElementById("loading");
const progressDots = document.querySelectorAll('.dot');
const letterBox = document.getElementById("letterBox");
const typingText = document.getElementById("typingText");
const cursor = document.querySelector(".cursor");
const skipBtn = document.getElementById("skipBtn");
const backBtn = document.getElementById("backBtn");
const memoryCounter = document.getElementById("memoryCounter");
const loveFill = document.getElementById("loveFill");
const loveText = document.getElementById("loveText");
const daysCounter = document.getElementById("daysCounter");

// --- CANVAS & TREE ELEMENTS ---
const canvas = document.getElementById("treeCanvas");
const ctx = canvas.getContext("2d");
const leafLayer = document.getElementById("treeContainer");
let animationFrameId;
let currentStage = 1;

// --- TYPEWRITER VARIABLES ---
const message = `My sweet Lakshtu üíñ,

You make my world brighter just by being in it.
Your smile, your voice, the way you talk ‚Äî everything feels magical.

Thank you for choosing me, caring for me,
and making my heart feel safe.

On your special day, I want you to know:

‚ú® You are precious beyond words.
‚ú® You are deeply loved.
‚ú® You are my favorite person in the entire world.

May this year bring you all the happiness you deserve,
and may our journey together continue to grow
with love, laughter, and beautiful memories.

Happy Birthday, my love! 
You mean everything to me. üíï

With all my love,
Always and forever...`;

let typingIndex = 0;
let isTyping = false;
let typingTimeout;
let skipTyping = false;

// --- HEART RAIN ---
let heartRainInterval;

// --- INITIALIZATION ---
window.addEventListener('load', () => {
  setTimeout(() => {
    loading.style.opacity = '0';
    setTimeout(() => {
      loading.style.display = 'none';
      startHeartRain();
      updateMemoryCounter(0);
      calculateDaysTogether();
    }, 500);
  }, 1000);
});

// --- DAYS COUNTER ---
function calculateDaysTogether() {
  // Set your relationship start date (YYYY, MM-1, DD)
  const startDate = new Date(2023, 0, 1); // January 1, 2023
  const today = new Date();
  const diffTime = Math.abs(today - startDate);
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  
  daysCounter.textContent = diffDays;
  
  // Animate the counter
  let current = 0;
  const increment = diffDays / 50;
  const timer = setInterval(() => {
    current += increment;
    if (current >= diffDays) {
      current = diffDays;
      clearInterval(timer);
    }
    daysCounter.textContent = Math.floor(current);
  }, 20);
}

// --- HEART RAIN ---
function startHeartRain() {
  heartRainInterval = setInterval(() => {
    if (Math.random() > 0.7) { // 30% chance to create a heart
      createHeart();
    }
  }, 300);
}

function createHeart() {
  const heart = document.createElement('div');
  heart.className = 'heart';
  heart.textContent = 'üíñ';
  heart.style.left = Math.random() * window.innerWidth + 'px';
  heart.style.color = `hsl(${Math.random() * 30 + 330}, 100%, 70%)`;
  heart.style.fontSize = (15 + Math.random() * 20) + 'px';
  heart.style.animationDuration = (3 + Math.random() * 4) + 's';
  heart.style.animationDelay = (Math.random() * 2) + 's';
  
  document.body.appendChild(heart);
  
  setTimeout(() => {
    heart.remove();
  }, 5000);
}

// --- CANVAS MANAGEMENT ---
function resizeCanvas() {
  if (canvas.width !== canvas.clientWidth || canvas.height !== canvas.clientHeight) {
    canvas.width = canvas.clientWidth;
    canvas.height = canvas.clientHeight;
    if (page2.classList.contains('active')) {
      drawTree(true);
    }
  }
}

window.addEventListener('resize', resizeCanvas);

function drawTree(clearFirst = false) {
  const trunkColor = getComputedStyle(body).getPropertyValue('--tree-trunk').trim();
  const branchColor = getComputedStyle(body).getPropertyValue('--tree-branch').trim();
  
  if (clearFirst) {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
  }

  const w = canvas.width;
  const h = canvas.height;
  const cw = w / 2;

  // Draw Trunk with gradient
  const trunkGradient = ctx.createLinearGradient(cw, h, cw, h * 0.2);
  trunkGradient.addColorStop(0, trunkColor);
  trunkGradient.addColorStop(1, branchColor);
  
  ctx.lineWidth = w * 0.05;
  ctx.strokeStyle = trunkGradient;
  ctx.lineCap = 'round';
  ctx.lineJoin = 'round';
  
  ctx.beginPath();
  ctx.moveTo(cw, h);
  ctx.bezierCurveTo(cw - w * 0.1, h * 0.7, cw - w * 0.05, h * 0.4, cw, h * 0.2);
  ctx.stroke();

  // Draw Branches
  ctx.lineWidth = w * 0.028;
  ctx.strokeStyle = branchColor;
  
  // Left branch
  ctx.beginPath();
  ctx.moveTo(cw, h * 0.2);
  ctx.bezierCurveTo(cw - w * 0.35, h * 0.1, cw - w * 0.15, h * 0.03, cw - w * 0.05, h * 0.15);
  ctx.stroke();

  // Right branch
  ctx.beginPath();
  ctx.moveTo(cw, h * 0.2);
  ctx.bezierCurveTo(cw + w * 0.35, h * 0.1, cw + w * 0.15, h * 0.03, cw + w * 0.05, h * 0.15);
  ctx.stroke();
}

function createLeaves() {
  leafLayer.querySelectorAll('.leaf').forEach(leaf => leaf.remove());
  
  const colors = ["#ff4fa6", "#ff8bd5", "#ff66cc", "#ff99ff", "#ffb3e6"];
  const w = canvas.width;
  const h = canvas.height;
  const cx = w / 2;
  const cy = h * 0.15;
  const maxR = w * 0.35;

  for (let i = 0; i < 150; i++) {
    let leaf = document.createElement("div");
    leaf.className = "leaf";
    leaf.style.background = colors[Math.floor(Math.random() * colors.length)];
    
    let angle = Math.random() * Math.PI * 2;
    let r = maxR * (0.2 + Math.random() * 0.8);
    
    leaf.style.left = (cx + r * Math.cos(angle)) + "px";
    leaf.style.top = (cy + r * Math.sin(angle * 1.1)) + "px";
    
    leaf.style.animationDelay = (Math.random() * 2) + "s";
    leafLayer.appendChild(leaf);
    
    setTimeout(() => {
      leaf.classList.add("grow");
    }, 100 + i * 10);
  }
}

function initPetals() {
  document.querySelectorAll('.petals').forEach(p => p.remove());

  for (let i = 0; i < 40; i++) {
    let p = document.createElement("div");
    p.className = "petals";
    p.style.left = Math.random() * window.innerWidth + "px";
    p.style.background = `hsl(${Math.random() * 30 + 330}, 100%, 70%)`;
    p.style.animationDuration = (2 + Math.random() * 4) + "s";
    p.style.animationDelay = (Math.random() * 3) + "s";
    document.body.appendChild(p);
  }
}

function initTree() {
  if (animationFrameId) {
    cancelAnimationFrame(animationFrameId);
  }
  resizeCanvas();
  drawTree(true);
  createLeaves();
  setTimeout(() => cake.classList.add("show"), 1500);
}

// --- PAGE TRANSITIONS ---
function updateProgress(stage) {
  progressDots.forEach((dot, index) => {
    if (index + 1 <= stage) {
      dot.classList.add('active');
    } else {
      dot.classList.remove('active');
    }
  });
  currentStage = stage;
}

function updateMemoryCounter(count) {
  memoryCounter.textContent = `Memories: ${count}/3`;
  memoryCounter.classList.add('show');
}

// Show skip button on stage 3
function showSkipButton() {
  skipBtn.classList.add('show');
}

function hideSkipButton() {
  skipBtn.classList.remove('show');
}

// Show back button on stages 2 and 3
function showBackButton() {
  backBtn.classList.add('show');
}

function hideBackButton() {
  backBtn.classList.remove('show');
}

envelope.onclick = () => {
  bgm.play().catch(e => console.log("Autoplay prevented:", e));
  page1.classList.remove("active");
  page2.classList.add("active");
  updateProgress(2);
  showBackButton();
  
  // Start animations
  setTimeout(() => {
    initPetals();
    initTree();
  }, 300);
  
  // Preload next stage images
  preloadImages(['pic_one.jpg', 'pic_two.jpg', 'pic_three.png']);
  
  // Update memory counter as images load
  let loadedCount = 0;
  ['pic_one.jpg', 'pic_two.jpg', 'pic_three.png'].forEach((src, index) => {
    const img = new Image();
    img.onload = () => {
      loadedCount++;
      updateMemoryCounter(loadedCount);
      
      // Update love meter based on loaded images
      const lovePercentage = Math.min(100, loadedCount * 33);
      loveFill.style.width = `${lovePercentage}%`;
      loveText.textContent = `Love Level: ${lovePercentage}%`;
    };
    img.src = src;
  });
}

cake.onclick = () => {
  page2.classList.remove("active");
  finalStage.classList.add("active");
  updateProgress(3);
  showSkipButton();
  letterBox.classList.add('show');
  
  if (animationFrameId) {
    cancelAnimationFrame(animationFrameId);
  }
  
  // Start typing after a short delay
  setTimeout(() => {
    startTyping();
  }, 1000);
}

// --- TYPEWRITER EFFECT ---
function startTyping() {
  if (isTyping) return;
  
  isTyping = true;
  typingIndex = 0;
  typingText.textContent = "";
  cursor.style.display = "inline-block";
  skipTyping = false;
  
  function typeCharacter() {
    if (skipTyping) {
      // Skip to end
      typingText.textContent = message;
      cursor.style.display = "none";
      isTyping = false;
      letterBox.scrollTop = 0;
      hideSkipButton();
      createConfetti();
      return;
    }
    
    if (typingIndex < message.length) {
      // Add current character
      const char = message.charAt(typingIndex);
      typingText.textContent += char;
      
      // Scroll to keep cursor in view
      letterBox.scrollTop = typingText.scrollHeight;
      
      typingIndex++;
      
      // Determine speed based on character
      let speed = 40; // Default speed
      
      if (char === '\n') speed = 300; // Pause at new lines
      else if (char === '.' || char === '!' || char === '?') speed = 200; // Pause at punctuation
      else if (char === ',') speed = 100; // Short pause at commas
      else if (char.match(/\s/)) speed = 60; // Slight pause at spaces
      else speed = 20 + Math.random() * 15; // Random typing speed
      
      // Create typing sound effect
      createTypingSound();
      
      // Continue typing
      typingTimeout = setTimeout(typeCharacter, speed);
    } else {
      // Typing complete
      cursor.style.display = "none";
      isTyping = false;
      hideSkipButton();
      createConfetti();
    }
  }
  
  // Start typing
  typeCharacter();
}

function skipTypingAnimation() {
  skipTyping = true;
  if (typingTimeout) {
    clearTimeout(typingTimeout);
  }
}

function createTypingSound() {
  // Simple typing sound effect using Web Audio API
  try {
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    oscillator.frequency.value = 800 + Math.random() * 400;
    oscillator.type = 'sine';
    
    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.05);
    
    oscillator.start(audioContext.currentTime);
    oscillator.stop(audioContext.currentTime + 0.05);
  } catch (e) {
    // Audio context not supported, continue silently
  }
}

// --- DAY/NIGHT MODE TOGGLE ---
let isDayMode = false;

moodToggle.onclick = () => {
  isDayMode = !isDayMode;
  if (isDayMode) {
    body.classList.add('day-mode');
    moodToggle.querySelector('.emoji').textContent = 'üåô';
    moodToggle.querySelector('.text').textContent = 'Night Mode';
  } else {
    body.classList.remove('day-mode');
    moodToggle.querySelector('.emoji').textContent = '‚òÄÔ∏è';
    moodToggle.querySelector('.text').textContent = 'Day Mode';
  }

  // Update tree colors if on tree stage
  if (page2.classList.contains('active')) {
    drawTree(true);
  }
};

// --- MUSIC PLAYER ---
let isMusicPlaying = false;

musicToggle.onclick = () => {
  if (isMusicPlaying) {
    bgm.pause();
    musicToggle.innerHTML = 'üîá';
    musicToggle.style.borderColor = 'var(--text-secondary)';
  } else {
    bgm.play().catch(e => console.log("Music play failed:", e));
    musicToggle.innerHTML = 'üéµ';
    musicToggle.style.borderColor = 'var(--accent)';
  }
  isMusicPlaying = !isMusicPlaying;
};

// Auto-play music on first interaction
document.addEventListener('click', () => {
  if (!isMusicPlaying && bgm.paused) {
    bgm.play().then(() => {
      isMusicPlaying = true;
      musicToggle.innerHTML = 'üéµ';
      musicToggle.style.borderColor = 'var(--accent)';
    }).catch(e => console.log("Autoplay prevented:", e));
  }
}, { once: true });

// --- IMAGE PRELOADING ---
function preloadImages(imageUrls) {
  imageUrls.forEach(url => {
    const img = new Image();
    img.src = url;
  });
}

// --- CONFETTI EFFECT ---
function createConfetti() {
  for (let i = 0; i < 100; i++) {
    let confetti = document.createElement("div");
    confetti.className = "petals";
    confetti.style.left = Math.random() * window.innerWidth + "px";
    confetti.style.background = `hsl(${Math.random() * 360}, 100%, 65%)`;
    confetti.style.animationDuration = (1 + Math.random() * 2) + "s";
    confetti.style.animationDelay = (Math.random() * 1) + "s";
    confetti.style.width = "8px";
    confetti.style.height = "8px";
    confetti.style.borderRadius = "50%";
    document.body.appendChild(confetti);
    
    setTimeout(() => {
      confetti.remove();
    }, 3000);
  }
}

// --- SKIP BUTTON ---
skipBtn.onclick = () => {
  if (isTyping) {
    skipTypingAnimation();
  }
};

// --- BACK BUTTON ---
backBtn.onclick = () => {
  if (currentStage === 3) {
    // Go back to tree stage
    finalStage.classList.remove("active");
    page2.classList.add("active");
    updateProgress(2);
    hideSkipButton();
    
    // Restart tree animation
    setTimeout(() => {
      initTree();
    }, 300);
  } else if (currentStage === 2) {
    // Go back to envelope stage
    page2.classList.remove("active");
    page1.classList.add("active");
    updateProgress(1);
    hideBackButton();
  }
};

// --- KEYBOARD NAVIGATION ---
document.addEventListener('keydown', (e) => {
  switch(e.key) {
    case 'ArrowRight':
    case ' ':
      if (currentStage === 1) envelope.click();
      else if (currentStage === 2) cake.click();
      break;
    case 'ArrowLeft':
      backBtn.click();
      break;
    case 'm':
    case 'M':
      moodToggle.click();
      break;
    case 's':
    case 'S':
      if (currentStage === 3 && isTyping) {
        skipTypingAnimation();
      }
      break;
    case 'Escape':
      backBtn.click();
      break;
  }
});

// --- TOUCH SUPPORT ---
let lastTap = 0;
document.addEventListener('touchend', (e) => {
  const currentTime = new Date().getTime();
  const tapLength = currentTime - lastTap;
  
  if (tapLength < 300 && tapLength > 0) {
    // Double tap - skip typing
    if (currentStage === 3 && isTyping) {
      skipTypingAnimation();
    }
  }
  
  lastTap = currentTime;
});

// --- INITIAL SETUP ---
resizeCanvas();
updateProgress(1);

// Auto-resize canvas periodically
setInterval(resizeCanvas, 1000);

// Show tap instruction after delay
setTimeout(() => {
  document.querySelectorAll('.tap-instruction').forEach(el => {
    el.style.opacity = '1';
  });
}, 2000);
</script>
</body>
</html>
